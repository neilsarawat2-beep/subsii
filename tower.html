<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Subsi ki Jang - Tower Mode</title>
<link rel="stylesheet" href="game-styles.css">
<style>
#dialog-box {position: absolute; inset: 0; z-index: 200; background: rgba(0,0,0,0.95); display: none; flex-direction: column; align-items: center; justify-content: center; padding: 40px;}
#dialog-text {color: #fff; font-size: 1.2rem; text-align: center; max-width: 800px; line-height: 1.8; margin-bottom: 30px; text-transform: none;}
.dialog-btn {background: #000; color: var(--cyber-blue); border: 2px solid var(--cyber-blue); padding: 15px 40px; cursor: pointer; font-family: 'Courier New'; font-weight: 900; margin: 0 10px; font-size: 1.1rem;}
.dialog-btn:hover {background: var(--cyber-blue); color: #000;}
#tower-level-ind {position: absolute; top: 10px; left: 50%; transform: translateX(-50%); color: #fff; font-size: 1.2rem; z-index: 20; text-shadow: 0 0 10px var(--cyber-blue); display: none;}
#trader-screen {position: absolute; inset: 0; z-index: 90; background: rgba(0,0,0,0.95); display: none; flex-direction: column; align-items: center; justify-content: center;}
.trade-opt {border: 1px solid gold; color: gold; margin-top: 10px; padding: 20px; width: 300px; text-align: center; cursor: pointer;}
.trade-opt:hover {background: gold; color: #000;}
.evo-flash {animation: evoFlash 1.5s ease-in-out;}
@keyframes evoFlash {0% {filter: brightness(1); transform: scale(1);} 50% {filter: brightness(10) blur(5px); transform: scale(1.2); border-color: #fff;} 100% {filter: brightness(1); transform: scale(1);}}
</style>
</head>
<body>
<div id="crt-overlay"></div>
<div id="game-window">
<button id="back-btn" onclick="location.href='index.html'">‚Üê BACK TO MENU</button>
<div id="tower-level-ind">FLOOR 1</div>

<div id="dialog-box"><div id="dialog-text"></div><div id="dialog-buttons"></div></div>

<div id="selection-screen">
<h1>TOWER MODE</h1>
<div id="sel-hint" style="color:#555; letter-spacing:4px; margin-bottom:10px;">[ SELECT STARTER UNIT ]</div>
<div class="grid" id="roster"></div>
</div>

<div id="trader-screen">
<h2 style="color: gold; font-size: 3rem; margin-bottom: 10px;">MYSTIC TRADER</h2>
<p style="color: #aaa; margin-bottom: 20px;">"Take this. You'll need it for the upper floors..."</p>
<div class="trade-opt" onclick="traderPick('HP')">HP POTION (+1)</div>
<div class="trade-opt" onclick="traderPick('ANTI')">ANTI SERUM (+1)</div>
<div class="trade-opt" onclick="traderPick('BUFF')">BUFF DATA (+1)</div>
<div class="trade-opt" onclick="traderPick('BKUP')">BACKUP DRIVE (+1)</div>
</div>

<div id="battle-screen">
<div id="ticker"></div>
<div class="hud-top">
<div style="width: 45%;">
<div style="display:flex; justify-content:space-between; align-items:flex-end;">
<span id="p1-n" style="font-weight:900; font-size: 1.4rem;"></span>
<span id="p1-sh" style="color:var(--cyber-blue); font-size:0.8rem;"></span>
</div>
<div class="hp-rail"><div id="p1-bar" class="hp-bar"></div></div>
<div id="p1-hp-num" class="hp-val-text">CORE: --/--</div>
<div id="p1-status" style="font-size:0.6rem; color:#f00; margin-top:2px; min-height:10px;"></div>
<div id="p1-trainer" style="font-size:0.7rem; color:var(--cyber-blue); margin-top:2px;">TR: ---</div>
<div id="p1-potion-block" style="font-size:0.6rem; color:#f00; margin-top:2px; min-height:10px;"></div>
</div>
<div style="width: 45%; text-align: right;">
<div style="display:flex; justify-content:space-between; align-items:flex-end;">
<span id="p2-sh" style="color:var(--cyber-blue); font-size:0.8rem;"></span>
<span id="p2-n" style="font-weight:900; font-size: 1.4rem;"></span>
</div>
<div class="hp-rail" style="direction: rtl;"><div id="p2-bar" class="hp-bar"></div></div>
<div id="p2-hp-num" class="hp-val-text">CORE: --/--</div>
<div id="p2-status" style="font-size:0.6rem; color:#f00; margin-top:2px; min-height:10px;"></div>
<div id="p2-trainer" style="font-size:0.7rem; color:var(--cyber-blue); margin-top:2px;">TR: ---</div>
<div id="p2-potion-block" style="font-size:0.6rem; color:#f00; margin-top:2px; min-height:10px;"></div>
</div>
</div>
<div id="arena-bg"><div id="s1" class="sprite"></div><div id="s2" class="sprite"></div></div>
<button id="exec-trigger" onclick="handleAction()">INITIATE STRIKE</button>
<div id="control-panel">
<div id="console">
<div style="color:var(--cyber-blue); font-weight:900; border-bottom: 1px solid #333; margin-bottom:10px;">>> TACTICAL READOUT</div>
<div>MODULE: <span id="c-title" class="data-val">---</span></div>
<div>ACCURACY: <span id="c-acc" class="data-val">---</span></div>
<div style="color:var(--term-red)">EST DAMAGE: <span id="c-dmg" class="data-val">---</span></div>
<div id="c-desc" style="color:#666; font-size:0.7rem; margin-top: auto;">// AWAITING MODULE...</div>
</div>
<div id="move-grid">
<button class="move-btn" id="cat-att" onclick="showSub('ATTACK')">ATTACK SET</button>
<button class="move-btn" id="cat-itm" onclick="showSub('ITEMS')">ITEM POUCH</button>
<button class="move-btn" id="b0" style="display:none;"></button>
<button class="move-btn" id="b1" style="display:none;"></button>
<button class="move-btn" id="b2" style="display:none;"></button>
<button class="move-btn" id="b3" style="display:none;"></button>
</div>
</div>
</div>
</div>

<script src="game-data.js"></script>
<script>
let p1,p2,turn=1,curM,selectionPhase=0,towerLevel=1,towerList=[],towerInventory=null,towerEvoStage=0,potionBlock={p1:0,p2:0,dmgReduction:{p1:0,p2:0}};

window.onload=()=>{
  document.getElementById('sel-hint').innerText="[ SELECT STARTER UNIT ]";
  loadBeasts();
};

function loadBeasts(){
  const r=document.getElementById('roster');r.innerHTML="";
  let pool=["Paricheymon","Debosmitamon","Smitimon"];
  pool.forEach(n=>{
    r.innerHTML+=`<div class="card" onclick="pick('${n}')" style="--b-color:${db[n].color}"><div class="beast-name">${n}</div><div class="beast-type">${db[n].type}</div></div>`;
  });
}

function loadTrainers(){
  const r=document.getElementById('roster');r.innerHTML="";
  Object.keys(trainers).forEach(n=>{
    if(n==="Lord Keshav")return;
    r.innerHTML+=`<div class="card" onclick="pickTrainer('${n}')" style="--b-color:${trainers[n].c}"><div class="beast-name">${n}</div><div class="beast-type" style="color:#fff; margin-bottom: 2px;">${trainers[n].name}</div><div style="font-size:0.5rem; color:#aaa; line-height:1;">${trainers[n].d}</div></div>`;
  });
}

function pick(n){
  let p={...db[n],n,cur:db[n].hp,stun:0,bleed:0,weak:0,shield:0,shieldLock:false,buff:0,accMod:0,evasion:0,used:[],lastMoveName:null,revived:0,hasDealtDmg:false,items:{HP:1,ANTI:1,BUFF:1,BKUP:1},trainer:null,trId:null,evoPath:n};
  p1=p;
  showTowerIntro(n);
}

function showTowerIntro(beastName){
  const dialogBox=document.getElementById('dialog-box');
  const dialogText=document.getElementById('dialog-text');
  const dialogButtons=document.getElementById('dialog-buttons');
  dialogText.innerHTML=`You dare to climb the Untameable tower of the DPS-122 with only one Campanian-${beastName}. Do you think you can win it, No. Many came and many passed by none managed to defeat this tower. NONE WAS ABLE TO FACE THE WRATH OF THIS TOWER and then there is YOU, a NOBODY.`;
  dialogButtons.innerHTML='<button class="dialog-btn" onclick="closeTowerIntro()">BEGIN</button>';
  dialogBox.style.display='flex';
}

function closeTowerIntro(){
  document.getElementById('dialog-box').style.display='none';
  document.getElementById('sel-hint').innerText="[ SELECT YOUR TRAINER ]";
  selectionPhase=1;
  loadTrainers();
}

function showEvolutionDialog(newName){
  const dialogBox=document.getElementById('dialog-box');
  const dialogText=document.getElementById('dialog-text');
  const dialogButtons=document.getElementById('dialog-buttons');
  dialogText.innerHTML=`It seems the beast has grown a fond liking towards you, it won't accept defeat for your honour, it won't die but evolve into something new into a- ${newName}`;
  dialogButtons.innerHTML='<button class="dialog-btn" onclick="closeEvolutionDialog()">CONTINUE</button>';
  dialogBox.style.display='flex';
}

function closeEvolutionDialog(){
  document.getElementById('dialog-box').style.display='none';
}

function pickTrainer(n){
  const tr=trainers[n];
  p1.trainer=n;p1.trId=tr.id;p1.trColor=tr.c;
  initTower();
}

function showFloor10Victory(){
  const dialogBox=document.getElementById('dialog-box');
  const dialogText=document.getElementById('dialog-text');
  const dialogButtons=document.getElementById('dialog-buttons');
  dialogText.innerHTML=`You are strong, brave and undoubtably the victor. You have defeated me- LORD KESHAV the spirit of this Tower but ohh you brave warrior, I have a request for you, a request for one last fight. DO YOU ACCEPT?`;
  dialogButtons.innerHTML='<button class="dialog-btn" onclick="acceptVibhamon()">YES</button><button class="dialog-btn" onclick="refuseVibhamon()">NO</button>';
  dialogBox.style.display='flex';
}

function acceptVibhamon(){
  document.getElementById('dialog-box').style.display='none';
  const dialogBox=document.getElementById('dialog-box');
  const dialogText=document.getElementById('dialog-text');
  const dialogButtons=document.getElementById('dialog-buttons');
  dialogText.innerHTML=`Ohh you brave warrior thank you for hearing my plea. In the basement of tower there is a beast, UNTAMED, UNSEEN, UNTOUCHED, but only HEARD OF- VIBHAMON. Once I see her I won't be able to do anything but I will become her trainer. It will force me to use my ability- GOD'S TOUCH. Let's go`;
  dialogButtons.innerHTML='<button class="dialog-btn" onclick="startVibhamonBattle()">FIGHT</button>';
  dialogBox.style.display='flex';
}

function refuseVibhamon(){
  document.getElementById('dialog-box').style.display='none';
  const dialogBox=document.getElementById('dialog-box');
  const dialogText=document.getElementById('dialog-text');
  const dialogButtons=document.getElementById('dialog-buttons');
  dialogText.innerHTML=`A wise choice indeed, congrats on defeating me and my army. Your name will echo in the walls of this tower as the one and only man to defeat GOD'S PLAN`;
  dialogButtons.innerHTML='<button class="dialog-btn" onclick="location.reload()">EXIT</button>';
  dialogBox.style.display='flex';
}

function startVibhamonBattle(){
  document.getElementById('dialog-box').style.display='none';
  towerLevel=11;
  startTowerMatch();
}

function showVibhamonVictory(){
  const dialogBox=document.getElementById('dialog-box');
  const dialogText=document.getElementById('dialog-text');
  const dialogButtons=document.getElementById('dialog-buttons');
  dialogText.innerHTML=`......... You are the HERO, a force that no one can stop, a true legend, the TRUE ALMIGHTY. Thank you. Ps I like Naysha`;
  dialogButtons.innerHTML='<button class="dialog-btn" onclick="location.href=\'index.html\'">EXIT</button>';
  dialogBox.style.display='flex';
}

function showDefeatDialog(){
  const dialogBox=document.getElementById('dialog-box');
  const dialogText=document.getElementById('dialog-text');
  const dialogButtons=document.getElementById('dialog-buttons');
  dialogText.innerHTML=`You are no match for me or my TOWER, you pathetic weakling courage less soul. Now run away, run as much as you want but you won't be able to run from the humiliation I had brought to you`;
  dialogButtons.innerHTML='<button class="dialog-btn" onclick="location.reload()">RETRY</button><button class="dialog-btn" onclick="location.href=\'index.html\'">MENU</button>';
  dialogBox.style.display='flex';
}

function initTower(){
  const allBeasts=Object.keys(db).filter(x=>x!==p1.n&&x!=="Vibhamon");
  towerList=allBeasts.sort(()=>0.5-Math.random());
  if(p1.trId==="SHUBHAN")p1.items.HP+=1;
  if(p1.trId==="NEIL")p1.items.BKUP=2;
  towerInventory={...p1.items};
  towerEvoStage=0;
  document.getElementById('selection-screen').style.display='none';
  document.getElementById('battle-screen').style.display='flex';
  document.getElementById('tower-level-ind').style.display='block';
  startTowerMatch();
}

function startTowerMatch(){
  if(towerLevel>11){showVibhamonVictory();return;}
  turn=1;
  p1.cur=p1.hp;
  p1.stun=0;p1.bleed=0;p1.weak=0;p1.shield=0;p1.shieldLock=false;p1.buff=0;p1.accMod=0;p1.evasion=0;p1.used=[];p1.revived=0;
  p1.items={...towerInventory};
  potionBlock={p1:0,p2:0,dmgReduction:{p1:0,p2:0}};
  
  let oppName;
  if(towerLevel===11){
    oppName="Vibhamon";
    p1.hp=p1.hp*2;
    p1.cur=p1.hp;
    p1.items.HP=5;
    p1.items.ANTI=5;
    p1.items.BUFF=5;
    p1.items.BKUP=5;
  }else if(towerLevel<=9)oppName=towerList[towerLevel-1];
  else oppName="MonsinMon";
  
  if(!oppName)oppName=Object.keys(db)[0];
  
  let p={...db[oppName],n:oppName,cur:db[oppName].hp,stun:0,bleed:0,weak:0,shield:0,shieldLock:false,buff:0,accMod:0,evasion:0,used:[],lastMoveName:null,revived:0,hasDealtDmg:false,items:{HP:1,ANTI:1,BUFF:1,BKUP:1},trainer:null,trId:null};
  
  if(towerLevel===11){
    p.trainer="Lord Keshav";
    p.trId="KESHAV";
    p.trColor="#ffffff";
  }else{
    const trKeys=Object.keys(trainers).filter(k=>k!=="Lord Keshav");
    const rndTr=trainers[trKeys[Math.floor(Math.random()*trKeys.length)]];
    p.trainer=Object.keys(trainers).find(key=>trainers[key]===rndTr);
    p.trId=rndTr.id;p.trColor=rndTr.c;
  }
  
  if(towerLevel!==11){
    // Reduce HP by 10 for quick runs
    p.hp=Math.max(10,p.hp-10+(towerLevel*2));
  }
  
  let bossTitle="";
  if(towerLevel===5){p.hp+=10;p.str+=1;bossTitle=" [MINI-BOSS]";}
  if(towerLevel===7){p.hp+=15;p.str+=2;bossTitle=" [MEGA-BOSS]";}
  if(towerLevel===10){p.hp+=25;p.str+=3;bossTitle=" [FINAL BOSS]";}
  if(towerLevel===11){bossTitle=" [ULTIMATE BOSS]";}
  
  p.cur=p.hp;
  p2=p;
  
  document.getElementById('tower-level-ind').innerText=towerLevel===11?`BASEMENT${bossTitle}`:`FLOOR ${towerLevel}/10${bossTitle}`;
  document.getElementById('tower-level-ind').style.color=(towerLevel===5||towerLevel===7||towerLevel===10||towerLevel===11)?'#f00':'#fff';
  
  if(p.trId==="SHUBHAN")p.items.HP+=1;
  if(p.trId==="NEIL")p.items.BKUP=2;
  
  setupVisuals();
  showMain();
}

function traderPick(item){
  towerInventory[item]++;
  document.getElementById('trader-screen').style.display='none';
  document.getElementById('battle-screen').style.display='flex';
  towerLevel++;
  startTowerMatch();
}

function setupVisuals(){
  document.getElementById('p1-n').innerText=p1.n;
  document.getElementById('p1-n').style.color=p1.color;
  document.getElementById('p2-n').innerText=p2.n;
  document.getElementById('p2-n').style.color=p2.color;
  document.getElementById('s1').innerText=p1.n[0];
  document.getElementById('s2').innerText=p2.n[0];
  document.getElementById('s1').style.setProperty('--b-color',p1.color);
  document.getElementById('s2').style.setProperty('--b-color',p2.color);
  update();
  
  let thiefMsg="";
  if(p1.trId==="RISHIT")thiefMsg+=stealItem(p1,p2,"P1");
  if(p2.trId==="RISHIT")thiefMsg+=stealItem(p2,p1,"P2");
  if(thiefMsg){
    const t=document.getElementById('ticker');
    t.innerHTML=`<div class='crit-text' style='color:#ff6600; font-size:1.2rem'>${thiefMsg}</div>`;
    setTimeout(()=>{t.innerHTML="";showMain();},2500);
  }else{showMain();}
}

function stealItem(thief,victim,tag){
  const avail=Object.keys(victim.items).filter(k=>victim.items[k]>0);
  if(avail.length>0){
    const s=avail[Math.floor(Math.random()*avail.length)];
    victim.items[s]--;thief.items[s]++;
    return `${tag} CHOR STOLE ${s.replace('_',' ')}! `;
  }return "";
}

function update(){
  [p1,p2].forEach((p,i)=>{
    let id=i+1;
    document.getElementById(`p${id}-bar`).style.width=(Math.max(0,p.cur)/p.hp*100)+"%";
    document.getElementById(`p${id}-bar`).style.setProperty('--b-color',p.color);
    document.getElementById(`p${id}-hp-num`).innerText=`CORE: ${Math.max(0,Math.floor(p.cur))}/${p.hp}`;
    document.getElementById(`p${id}-sh`).innerText=p.shield>0?`SHIELD:${p.shield}`:(p.shieldLock?"[LOCK]":"");
    let st=[];
    if(p.bleed>0)st.push(`BLEED(${p.bleed})`);
    if(p.weak>0)st.push(`WEAK(${p.weak})`);
    if(p.buff>0)st.push("BUFFED");
    if(p.evasion>0)st.push("EVA");
    document.getElementById(`p${id}-status`).innerText=st.join(" | ");
    const tr=document.getElementById(`p${id}-trainer`);
    tr.innerText=`TR: ${p.trainer}`;
    tr.style.color=p.trColor;
    
    const potBlock=i===0?potionBlock.p1:potionBlock.p2;
    const pbEl=document.getElementById(`p${id}-potion-block`);
    if(pbEl)pbEl.innerText=potBlock>0?`POTION BLOCKED (${potBlock})`:"";
  });
  
  document.getElementById('p1-n').innerText=p1.n;
  document.getElementById('p1-n').style.color=p1.color;
  document.getElementById('s1').innerText=p1.n[0];
  document.getElementById('s1').style.setProperty('--b-color',p1.color);
}

function showMain(){
  document.getElementById('ticker').innerText="";
  if(turn===2){setTimeout(cpuAI,1000);return;}
  document.getElementById('cat-att').style.display='block';
  document.getElementById('cat-itm').style.display='block';
  for(let i=0;i<4;i++){
    document.getElementById('b'+i).style.display='none';
    document.getElementById('b'+i).classList.remove('selected');
  }
  document.getElementById('exec-trigger').style.display='none';
  document.getElementById('s1').classList.toggle('active-sprite',turn===1);
  document.getElementById('s2').classList.toggle('active-sprite',turn===2);
}

function showSub(m){
  document.getElementById('cat-att').style.display='none';
  document.getElementById('cat-itm').style.display='none';
  const a=turn===1?p1:p2;
  const o=turn===1?p2:p1;
  const potBlock=turn===1?potionBlock.p1:potionBlock.p2;
  
  if(m==='ATTACK'){
    a.moves.forEach((mv,i)=>{
      let b=document.getElementById('b'+i);
      b.style.display='block';
      b.innerText=mv.n;
      b.disabled=(a.used.includes(mv.n)||(mv.t==="SHIELD"&&a.shieldLock));
      b.onclick=()=>prep(mv,i,false);
    });
  }else{
    const itms=[{n:"HP POTION",t:"HP",v:a.items.HP,d:"+7 HP"},{n:"ANTI",t:"ANTI",v:a.items.ANTI,d:"Clear status"},{n:"BUFF",t:"BUFF",v:a.items.BUFF,d:"+3 DMG & +10% ACC"},{n:"BACKUP",t:"BKUP",v:a.items.BKUP,d:"Revive Life"}];
    itms.forEach((it,i)=>{
      let b=document.getElementById('b'+i);
      b.style.display='block';
      b.innerText=`${it.n}(${it.v})`;
      b.disabled=(it.v<=0||(o.trId==="NAYSHA"&&(it.t==="HP"||it.t==="ANTI"))||(potBlock>0&&(it.t==="HP"||it.t==="ANTI")));
      b.onclick=()=>prep(it,i,true);
    });
  }
}

function prep(m,i,isItm){
  const a=turn===1?p1:p2;
  const o=turn===1?p2:p1;
  curM={...m,isItem:isItm};
  
  for(let j=0;j<4;j++)document.getElementById('b'+j).classList.remove('selected');
  if(i!==-1)document.getElementById('b'+i).classList.add('selected');
  
  document.getElementById('c-title').innerText=m.n;
  
  let acc=m.p||100;
  let mods=a.accMod;
  const isSp=(m.t==="DMG"||m.t==="RAND_DMG"||m.t==="STUN"||m.t==="SILENCE");
  
  if(!isItm&&o.trId==="UDAY"&&isSp&&m.t!=="WIS"&&m.t!=="SHIELD")mods-=15;
  if(!isItm&&a.trId==="CHAHAK"&&isSp)mods+=10;
  
  document.getElementById('c-acc').innerText=(isItm?100:Math.min(100,acc+mods))+"%";
  
  let d=m.val||"EFF";
  if(m.t==="RISK")d=10;
  if(a.trId==="CHAHAK"&&isSp&&!isNaN(d))d=parseInt(d)+2;
  
  document.getElementById('c-dmg').innerText=d;
  document.getElementById('c-desc').innerText=`// ${m.d||"Active"}`;
  
  if(turn===1)document.getElementById('exec-trigger').style.display='block';
}

// Battle functions from 1player.html - handleAction, cpuAI, checkDeath, endTurn
// Plus tryEvolution function specific to tower mode

  <script>
/* =========================
   TOWER MODE BATTLE ENGINE
   ========================= */

function handleAction(){
  const a = turn === 1 ? p1 : p2;
  const o = turn === 1 ? p2 : p1;

  if(!curM) return;

  document.getElementById('exec-trigger').style.display='none';

  let log = "";

  // Accuracy check
  let acc = curM.p || 100;
  let roll = Math.random() * 100;
  if(roll > acc && !curM.isItem){
    log = `${a.n}'s ${curM.n} MISSED!`;
    ticker(log);
    endTurn();
    return;
  }

  // ITEM LOGIC
  if(curM.isItem){
    if(curM.t === "HP"){
      a.items.HP--;
      a.cur = Math.min(a.hp, a.cur + 7);
      log = `${a.n} restored HP`;
    }
    if(curM.t === "ANTI"){
      a.items.ANTI--;
      a.bleed = a.stun = a.weak = 0;
      log = `${a.n} cleared all effects`;
    }
    if(curM.t === "BUFF"){
      a.items.BUFF--;
      a.buff = 1;
      log = `${a.n} is BUFFED`;
    }
    if(curM.t === "BKUP"){
      a.items.BKUP--;
      if(a.cur <= 0){
        a.cur = 5;
        a.revived = 1;
        log = `${a.n} REVIVED`;
      }
    }
    update();
    ticker(log);
    endTurn();
    return;
  }

  // DAMAGE / EFFECTS
  if(curM.val){
    let dmg = curM.val;
    if(a.buff) dmg += 3;
    if(o.weak) dmg = Math.floor(dmg / 2);
    o.cur -= dmg;
    log = `${a.n} used ${curM.n} (${dmg} DMG)`;
    a.hasDealtDmg = true;
  }

  // STATUS EFFECTS
  switch(curM.t){
    case "STUN": o.stun = 2; break;
    case "BLEED": o.bleed = 3; break;
    case "WEAK": o.weak = 2; break;
    case "SHIELD": a.shield = 3; a.shieldLock = true; break;
    case "LEECH": a.cur = Math.min(a.hp, a.cur + curM.val); break;
  }

  if(curM.once) a.used.push(curM.n);

  update();
  ticker(log);
  checkDeath();
}

function cpuAI(){
  if(p2.stun > 0){
    p2.stun--;
    ticker(`${p2.n} is STUNNED`);
    endTurn();
    return;
  }

  const usable = p2.moves.filter(m => !p2.used.includes(m.n));
  curM = usable[Math.floor(Math.random()*usable.length)];
  handleAction();
}

function endTurn(){
  const a = turn === 1 ? p1 : p2;

  if(a.bleed > 0){
    a.cur -= 1;
    a.bleed--;
  }
  if(a.weak > 0) a.weak--;
  if(a.buff > 0) a.buff = 0;

  turn = turn === 1 ? 2 : 1;
  update();
  showMain();
}

function checkDeath(){
  if(p1.cur <= 0){
    showDefeatDialog();
    return;
  }
  if(p2.cur <= 0){
    if(towerLevel === 10){
      showFloor10Victory();
      return;
    }
    document.getElementById('trader-screen').style.display='flex';
    document.getElementById('battle-screen').style.display='none';
    return;
  }
  endTurn();
}

function ticker(msg){
  const t = document.getElementById('ticker');
  t.innerHTML = `<div class="crit-text">${msg}</div>`;
  setTimeout(()=>t.innerHTML="",1200);
}
</script>
</body>
</html>
