<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Subsi ki Jang - Tower Mode</title>
<style>
:root {
  --term-green: #0f0;
  --term-red: #f00;
  --cyber-blue: #00f3ff;
  --void: #050505;
  --panel-bg: #0a0a0a;
  --scan-line: rgba(0,0,0,0.5);
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  background: #000;
  color: #e0e0e0;
  font-family: 'Courier New', monospace;
  margin: 0;
  min-height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
  overflow: hidden;
  text-transform: uppercase;
  position: relative;
}

#crt-overlay {
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 999;
  background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%),
              linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
  background-size: 100% 2px, 3px 100%;
  animation: flicker 0.15s infinite;
}

@keyframes flicker {
  0% { opacity: 0.97; }
  100% { opacity: 1; }
}

#game-window {
  width: 100vw;
  height: 100vh;
  max-width: 100%;
  max-height: 100%;
  background: var(--void);
  border: none;
  display: flex;
  flex-direction: column;
  position: relative;
  box-shadow: none;
  overflow: hidden;
}

@media (min-width: 768px) and (min-aspect-ratio: 4/3) {
  #game-window {
    width: 95vw;
    height: 95vh;
    max-width: 1200px;
    max-height: 850px;
    border: 1px solid #333;
    box-shadow: 0 0 20px rgba(0,0,0,0.8);
  }
}

#selection-screen {
  position: absolute;
  inset: 0;
  z-index: 100;
  background: #020202;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 10px;
  overflow-y: auto;
}

#selection-screen h1 {
  font-size: clamp(2rem, 8vw, 4rem);
  color: #fff;
  text-shadow: 2px 2px 0px var(--cyber-blue);
  margin-bottom: 10px;
  letter-spacing: clamp(3px, 1vw, 10px);
  font-weight: 900;
  animation: glitch 2s infinite;
  text-align: center;
}

@keyframes glitch {
  0% {transform: translate(0)}
  20% {transform: translate(-2px, 2px)}
  40% {transform: translate(-2px, -2px)}
  60% {transform: translate(2px, 2px)}
  80% {transform: translate(2px, -2px)}
  100% {transform: translate(0)}
}

.grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 10px;
  width: 100%;
  max-width: 1000px;
  padding: 10px;
}

@media (max-width: 767px) {
  .grid {
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
  }
}

@media (min-width: 768px) {
  .grid {
    grid-template-columns: repeat(5, 1fr);
    gap: 15px;
  }
}

.card {
  background: #000;
  border: 2px solid #333;
  padding: clamp(8px, 2vw, 15px);
  cursor: pointer;
  transition: 0.2s;
  position: relative;
  min-height: 80px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  touch-action: manipulation;
}

.card:hover, .card:active {
  border-color: var(--b-color);
  background: #080808;
  box-shadow: 0 0 15px var(--b-color);
  transform: scale(1.02);
}

.card::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  width: 5px;
  height: 100%;
  background: var(--b-color);
}

.beast-name {
  font-size: clamp(0.8rem, 2.5vw, 1.1rem);
  font-weight: 900;
  color: #fff;
}

.beast-type {
  font-size: clamp(0.5rem, 1.5vw, 0.6rem);
  letter-spacing: 1px;
  color: var(--b-color);
  font-weight: bold;
}

#battle-screen {
  display: none;
  flex: 1;
  flex-direction: column;
  width: 100%;
  height: 100%;
}

#arena-bg {
  flex: 1;
  position: relative;
  display: flex;
  justify-content: space-around;
  align-items: center;
  background: radial-gradient(circle at center, rgba(0, 243, 255, 0.2) 0%, transparent 75%),
              linear-gradient(rgba(0,0,0,0.9), rgba(0,0,0,0.5)),
              repeating-linear-gradient(0deg, transparent 0, transparent 1px, rgba(0, 243, 255, 0.1) 1px, transparent 2px) 0 0 / 100% 40px,
              repeating-linear-gradient(90deg, transparent 0, transparent 1px, rgba(0, 243, 255, 0.1) 1px, transparent 2px) 0 0 / 40px 100%;
  perspective: 500px;
  padding: 10px;
}

.hud-top {
  height: auto;
  min-height: 80px;
  display: flex;
  justify-content: space-between;
  padding: clamp(10px, 2vw, 20px);
  gap: 10px;
  background: #080808;
  border-bottom: 2px solid #333;
  z-index: 10;
}

@media (max-width: 767px) {
  .hud-top {
    flex-direction: column;
    padding: 10px;
  }
  .hud-top > div {
    width: 100% !important;
  }
}

.hp-rail {
  width: 100%;
  height: clamp(16px, 3vw, 24px);
  background: #111;
  border: 2px solid #444;
  margin-top: 8px;
  position: relative;
}

.hp-bar {
  height: 100%;
  width: 100%;
  transition: width 0.3s;
  background-image: repeating-linear-gradient(-45deg, var(--b-color) 0px, var(--b-color) 10px, #000 10px, #000 12px);
  box-shadow: 0 0 10px var(--b-color);
}

.hp-val-text {
  font-size: clamp(0.6rem, 1.5vw, 0.8rem);
  color: #888;
  margin-top: 4px;
  letter-spacing: 1px;
  font-weight: bold;
}

.sprite {
  width: clamp(100px, 20vw, 180px);
  height: clamp(100px, 20vw, 180px);
  border: 2px solid var(--cyber-blue);
  background: rgba(0,0,0,0.7);
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: clamp(3rem, 8vw, 5rem);
  font-weight: 900;
  color: #fff;
  text-shadow: 0 0 15px var(--cyber-blue);
  transition: 0.3s;
  position: relative;
}

.active-sprite {
  border-color: #fff;
  box-shadow: 0 0 30px #fff;
  transform: scale(1.1);
}

.evo-flash {
  animation: evoFlash 1.5s ease-in-out;
}

@keyframes evoFlash {
  0% { filter: brightness(1); transform: scale(1); }
  50% { filter: brightness(10) blur(5px); transform: scale(1.2); border-color: #fff; }
  100% { filter: brightness(1); transform: scale(1); }
}

#control-panel {
  height: auto;
  min-height: 200px;
  background: #000;
  display: flex;
  border-top: 2px solid #333;
  flex-wrap: wrap;
}

@media (max-width: 767px) {
  #control-panel {
    flex-direction: column;
    min-height: auto;
  }
}

#console {
  width: 35%;
  min-width: 200px;
  padding: clamp(10px, 2vw, 20px);
  border-right: 1px solid #333;
  font-size: clamp(0.6rem, 1.5vw, 0.8rem);
  color: #aaa;
  display: flex;
  flex-direction: column;
}

@media (max-width: 767px) {
  #console {
    width: 100%;
    border-right: none;
    border-bottom: 1px solid #333;
  }
}

.data-val {
  color: #fff;
  font-weight: bold;
}

#move-grid {
  flex: 1;
  padding: clamp(10px, 2vw, 20px);
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: clamp(8px, 2vw, 15px);
  min-width: 250px;
}

.move-btn {
  background: #0a0a0a;
  color: #555;
  border: 1px solid #333;
  cursor: pointer;
  font-weight: 900;
  font-family: 'Courier New';
  padding: clamp(8px, 2vw, 12px);
  font-size: clamp(0.7rem, 1.5vw, 0.9rem);
  touch-action: manipulation;
  min-height: 40px;
}

.move-btn.selected {
  border-color: var(--cyber-blue);
  color: var(--cyber-blue);
  background: rgba(0, 243, 255, 0.05);
}

#exec-trigger {
  position: absolute;
  bottom: clamp(200px, 25vh, 265px);
  left: 50%;
  transform: translateX(-50%);
  padding: clamp(10px, 2vw, 15px) clamp(20px, 4vw, 40px);
  background: #f00;
  color: #000;
  border: none;
  font-weight: 900;
  cursor: pointer;
  display: none;
  z-index: 20;
  clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%);
  font-size: clamp(0.8rem, 2vw, 1rem);
  touch-action: manipulation;
}

#ticker {
  position: absolute;
  top: clamp(80px, 15vh, 150px);
  left: 50%;
  transform: translateX(-50%);
  font-weight: 900;
  z-index: 50;
  font-size: clamp(1.5rem, 5vw, 3rem);
  pointer-events: none;
  text-align: center;
  width: 90%;
  max-width: 800px;
}

.crit-text {
  color: #f00;
  border: clamp(2px, 0.5vw, 4px) solid #f00;
  padding: clamp(5px, 1vw, 10px) clamp(10px, 2vw, 20px);
  background: rgba(0,0,0,0.8);
  transform: rotate(-5deg);
  display: inline-block;
}

.shake {
  animation: shake 0.3s;
}

@keyframes shake {
  10%, 90% { transform: translate3d(-4px, 0, 0); }
  20%, 80% { transform: translate3d(8px, 0, 0); }
  30%, 50%, 70% { transform: translate3d(-10px, 0, 0); }
}

#back-btn {
  position: absolute;
  top: clamp(10px, 2vw, 20px);
  left: clamp(10px, 2vw, 20px);
  background: #000;
  color: var(--cyber-blue);
  border: 2px solid var(--cyber-blue);
  padding: clamp(8px, 1.5vw, 10px) clamp(15px, 2vw, 20px);
  cursor: pointer;
  font-family: 'Courier New';
  font-weight: 900;
  z-index: 200;
  font-size: clamp(0.7rem, 1.5vw, 0.9rem);
  touch-action: manipulation;
}

#back-btn:hover, #back-btn:active {
  background: var(--cyber-blue);
  color: #000;
}

#dialog-box {
  position: absolute;
  inset: 0;
  z-index: 200;
  background: rgba(0,0,0,0.95);
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

#dialog-text {
  color: #fff;
  font-size: clamp(0.9rem, 2vw, 1.2rem);
  text-align: center;
  max-width: 800px;
  line-height: 1.8;
  margin-bottom: 20px;
  text-transform: none;
}

.dialog-btn {
  background: #000;
  color: var(--cyber-blue);
  border: 2px solid var(--cyber-blue);
  padding: clamp(10px, 2vw, 15px) clamp(20px, 3vw, 40px);
  cursor: pointer;
  font-family: 'Courier New';
  font-weight: 900;
  margin: 5px;
  font-size: clamp(0.8rem, 1.8vw, 1.1rem);
  touch-action: manipulation;
}

.dialog-btn:hover {
  background: var(--cyber-blue);
  color: #000;
}

#tower-level-ind {
  position: absolute;
  top: 10px;
  left: 50%;
  transform: translateX(-50%);
  color: #fff;
  font-size: clamp(0.9rem, 2vw, 1.2rem);
  z-index: 20;
  text-shadow: 0 0 10px var(--cyber-blue);
  display: none;
}

#trader-screen {
  position: absolute;
  inset: 0;
  z-index: 90;
  background: rgba(0,0,0,0.95);
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.trade-opt {
  border: 1px solid gold;
  color: gold;
  margin: 10px 0;
  padding: clamp(15px, 2vw, 20px);
  width: 90%;
  max-width: 300px;
  text-align: center;
  cursor: pointer;
  font-size: clamp(0.8rem, 1.8vw, 1rem);
  touch-action: manipulation;
}

.trade-opt:hover {
  background: gold;
  color: #000;
}

@media (max-width: 767px) {
  body {
    overflow-y: auto;
  }
  
  #game-window {
    min-height: 100vh;
  }
  
  #arena-bg {
    flex-direction: column;
    gap: 20px;
    padding: 20px 10px;
  }
}
</style>
</head>
<body>
<div id="crt-overlay"></div>
<div id="game-window">
<button id="back-btn" onclick="location.href='index.html'">‚Üê BACK</button>
<div id="tower-level-ind">FLOOR 1</div>
<div id="dialog-box"><div id="dialog-text"></div><div id="dialog-buttons"></div></div>
<div id="selection-screen">
<h1>TOWER MODE</h1>
<div id="sel-hint" style="color:#555; letter-spacing:2px; margin-bottom:10px; font-size: clamp(0.7rem, 1.5vw, 0.9rem);">[ SELECT STARTER UNIT ]</div>
<div class="grid" id="roster"></div>
</div>
<div id="trader-screen">
<h2 style="color: gold; font-size: clamp(2rem, 5vw, 3rem); margin-bottom: 10px;">Dalaal Pathak</h2>
<p style="color: #aaa; margin-bottom: 20px; text-transform: none;">"Take this. You'll need it for the upper floors..."</p>
<div class="trade-opt" onclick="traderPick('HP')">DUDUUU(+1)</div>
<div class="trade-opt" onclick="traderPick('ANTI')">ANTI SERUM (+1)</div>
<div class="trade-opt" onclick="traderPick('BUFF')">BUFF DATA (+1)</div>
<div class="trade-opt" onclick="traderPick('BKUP')">BACKUP DRIVE (+1)</div>
</div>
<div id="battle-screen">
<div id="ticker"></div>
<div class="hud-top">
<div style="width: 45%;">
<div style="display:flex; justify-content:space-between; align-items:flex-end; flex-wrap: wrap;">
<span id="p1-n" style="font-weight:900; font-size: clamp(1rem, 2.5vw, 1.4rem);"></span>
<span id="p1-sh" style="color:var(--cyber-blue); font-size: clamp(0.6rem, 1.5vw, 0.8rem);"></span>
</div>
<div class="hp-rail"><div id="p1-bar" class="hp-bar"></div></div>
<div id="p1-hp-num" class="hp-val-text">CORE: --/--</div>
<div id="p1-status" style="font-size: clamp(0.5rem, 1.2vw, 0.6rem); color:#f00; margin-top:2px; min-height:10px;"></div>
<div id="p1-trainer" style="font-size: clamp(0.6rem, 1.3vw, 0.7rem); color:var(--cyber-blue); margin-top:2px;">TR: ---</div>
<div id="p1-potion-block" style="font-size: clamp(0.5rem, 1.2vw, 0.6rem); color:#f00; margin-top:2px; min-height:10px;"></div>
</div>
<div style="width: 45%; text-align: right;">
<div style="display:flex; justify-content:space-between; align-items:flex-end; flex-wrap: wrap;">
<span id="p2-sh" style="color:var(--cyber-blue); font-size: clamp(0.6rem, 1.5vw, 0.8rem);"></span>
<span id="p2-n" style="font-weight:900; font-size: clamp(1rem, 2.5vw, 1.4rem);"></span>
</div>
<div class="hp-rail" style="direction: rtl;"><div id="p2-bar" class="hp-bar"></div></div>
<div id="p2-hp-num" class="hp-val-text">CORE: --/--</div>
<div id="p2-status" style="font-size: clamp(0.5rem, 1.2vw, 0.6rem); color:#f00; margin-top:2px; min-height:10px;"></div>
<div id="p2-trainer" style="font-size: clamp(0.6rem, 1.3vw, 0.7rem); color:var(--cyber-blue); margin-top:2px;">TR: ---</div>
<div id="p2-potion-block" style="font-size: clamp(0.5rem, 1.2vw, 0.6rem); color:#f00; margin-top:2px; min-height:10px;"></div>
</div>
</div>
<div id="arena-bg"><div id="s1" class="sprite"></div><div id="s2" class="sprite"></div></div>
<button id="exec-trigger" onclick="handleAction()">INITIATE STRIKE</button>
<div id="control-panel">
<div id="console">
<div style="color:var(--cyber-blue); font-weight:900; border-bottom: 1px solid #333; margin-bottom:10px;">>> TACTICAL READOUT</div>
<div>MODULE: <span id="c-title" class="data-val">---</span></div>
<div>ACCURACY: <span id="c-acc" class="data-val">---</span></div>
<div style="color:var(--term-red)">EST DAMAGE: <span id="c-dmg" class="data-val">---</span></div>
<div id="c-desc" style="color:#666; font-size: clamp(0.6rem, 1.2vw, 0.7rem); margin-top: auto;">// AWAITING MODULE...</div>
</div>
<div id="move-grid">
<button class="move-btn" id="cat-att" onclick="showSub('ATTACK')">ATTACK SET</button>
<button class="move-btn" id="cat-itm" onclick="showSub('ITEMS')">ITEM POUCH</button>
<button class="move-btn" id="b0" style="display:none;"></button>
<button class="move-btn" id="b1" style="display:none;"></button>
<button class="move-btn" id="b2" style="display:none;"></button>
<button class="move-btn" id="b3" style="display:none;"></button>
</div>
</div>
</div>
</div>
<script>
// Game Data
const db = {
  "Paricheymon": { hp: 30, str: 5, spd: 8, type: "WATER", color: "#00d2ff", moves: [{n:"Water Pump",p:80,val:5,t:"DMG",d:"5 HP hydro-blast."}, {n:"Bald Shine",p:70,t:"STUN",d:"Stun for 2 turns."}, {n:"Kick run",p:100,val:3,t:"RAND_DMG",min:2,max:4,d:"Deals 2-4 HP."}, {n:"Quick dodge",p:80,t:"EVA",d:"50% Evasion next hit."}]},
  "Debosmitamon": { hp: 32, str: 8, spd: 3, type: "GRASS", color: "#45f542", moves: [{n:"Membrane",p:100,t:"SHIELD",d:"3-Hit Defensive Layer."}, {n:"Root Hold",p:100,val:3,t:"RAND_DMG",min:2,max:4,d:"Catch prey (2-4 HP)."}, {n:"Pollen Burst",p:50,val:6,t:"DMG",d:"6 HP burst."}, {n:"Quick dodge",p:50,t:"EVA",d:"50% Evasion next hit."}]},
  "Smitimon": { hp: 28, str: 8, spd: 7, type: "FIRE", color: "#ff5e00", moves: [{n:"Roll no. 1",p:60,val:3,t:"LEECH",d:"Siphon 3 HP to Self."}, {n:"SEA",p:100,val:3,t:"DMG",d:"Thermal hit (3 HP)."}, {n:"Padhai Mat",p:60,t:"WEAK",d:"Opp deals 50% less dmg."}, {n:"Quick dodge",p:50,t:"EVA",d:"50% Evasion next hit."}]},
  "Swatimon": { hp: 34, str: 7, spd: 3, type: "SPACE", color: "#9d00ff", moves: [{n:"Wisdom",p:90,t:"WIS",d:"Deals 1/2 Opp HP if Higher."}, {n:"Irony",p:100,t:"SWAP",once:true,d:"Swap HP; Skip turn."}, {n:"Pause",p:50,t:"STUN",d:"Opp skips 2 turns."}, {n:"Metaphor",p:100,val:3,t:"DMG",d:"3 HP direct strike."}]},
  "GarimaJmon": { hp: 37, str: 7, spd: 5, type: "GHOST", color: "#ff0055", moves: [{n:"Wrath",p:20,t:"WRATH",d:"Set Opp HP to 1. Breaks Shield."}, {n:"Totalitarian",p:50,t:"STUN",once:true,d:"Stun 2 turns."}, {n:"Bratt!",p:100,val:4,t:"DMG",d:"4 HP strike."}, {n:"Escapism",p:60,t:"EVA",d:"50% Evasion next hit."}]},
  "Deepalimon": { hp: 33, str: 7, spd: 5, type: "IRON", color: "#00ff95", moves: [{n:"Death Stare",p:100,t:"DS",d:"Execute if HP < 30%."}, {n:"Silence",p:50,val:4,t:"STUN",d:"4 HP + 1 Turn Stun."}, {n:"Chem Burst",p:100,val:3,t:"DMG",d:"3 HP hit."}, {n:"Out Syllabus",p:40,t:"STUN",d:"Stun 2 Turns."}]},
  "Rohitmon": { hp: 30, str: 8, spd: 8, type: "COMBAT", color: "#ffcc00", moves: [{n:"Dunk",p:60,val:4,t:"BLEED",d:"4 HP + Bleed (3 turns)."}, {n:"Intimidate",p:50,t:"STUN",d:"Stun 1 Turn."}, {n:"Jawline cut",p:100,val:3,t:"DMG",d:"3 HP cut."}, {n:"Quick Dodge",p:60,t:"EVA",d:"50% Evasion next hit."}]},
  "MonsinMon": { hp: 35, str: 9, spd: 7, type: "LEGEND", color: "#ffffff", moves: [{n:"Inshallah",p:60,t:"RISK",d:"Lose 8 HP on HIT -> Deal 10 Pierce DMG."}, {n:"Iron Body",p:100,t:"SHIELD",d:"3-Hit Defensive Layer."}, {n:"KhatnaCut",p:100,val:3,t:"DMG",d:"3 HP hit."}, {n:"Quick dodge",p:50,t:"EVA",d:"50% Evasion next hit."}]},
  "Etikamon": { hp: 34, str: 8, spd: 6, type: "NATURE", color: "#a6ff00", moves: [{n:"Child Throw",p:60,t:"BLEED_RAND",d:"1-2 HP + Bleed."}, {n:"Tapasya",p:100,t:"HEAL",d:"Recover 3 HP."}, {n:"Compass",p:100,val:3,t:"DMG"}, {n:"Quick Dodge",p:50,t:"EVA",d:"50% Evasion next hit."}]},
  "PradeepMon": { hp: 34, str: 8, spd: 8, type: "MYSTIC", color: "#0077ff", moves: [{n:"Bohot dekhe hai",p:60,t:"BLEED",d:"Infects Opp with Bleed (3 turns)."}, {n:"Bald burst",p:60,val:4,t:"SILENCE",d:"4 HP + 1 Turn Stun."}, {n:"Go out",p:40,t:"STUN",d:"Stun 2 Turns."}, {n:"BABU",p:100,val:3,t:"DMG"}]},
  "Vibhamon": { hp: 150, str: 12, spd: 10, type: "ULTIMATE", color: "#ff0000", moves: [{n:"Resticate",p:40,val:0,t:"PERCENT",d:"50% of user HP."}, {n:"Suspend",p:100,val:5,t:"DMG",d:"5 HP damage."}, {n:"Speech",p:20,t:"SPEECH_STUN",d:"3 turn stun."}, {n:"Principle's Warrant",p:100,t:"WARRANT",d:"No potions for 5 turns, -2 DMG."}]}
};

const evoTree = {
  "Paricheymon": ["Deepalimon", "PradeepMon"],
  "Debosmitamon": ["Etikamon", "Swatimon"],
  "Smitimon": ["Rohitmon", "MonsinMon"]
};

const trainers = {
  "Kashmiri Adya": {id: "ADYA", c: "#ff9933", name: "Pather fekh", d: "Opp takes 1 Bleed on attack."},
  "Bengali Noel": {id: "NOEL", c: "#ff0099", name: "Kaala Jaadu", d: "Bleed 2HP/turn if dmg dealt."},
  "Milky Shubhan": {id: "SHUBHAN", c: "#00ccff", name: "Dudh", d: "+1 Heal Potion at start."},
  "Gitthi Naysha": {id: "NAYSHA", c: "#ffd700", name: "Judge", d: "Opp cannot use Heal/Anti."},
  "Kaala Uday": {id: "UDAY", c: "#9933ff", name: "Andhera", d: "Opp Acc -15% on non-specials."},
  "Fatima Chahak": {id: "CHAHAK", c: "#00ff00", name: "Maksad", d: "+2 DMG & +10% ACC on Specials."},
  "Bihari Rishit": {id: "RISHIT", c: "#ff6600", name: "Chor", d: "Steals 1 random item at start."},
  "Janwar Neil": {id: "NEIL", c: "#4b0082", name: "Bhukad", d: "2 Backup Potions (5HP & 3HP)."},
  "Khamba Aayansh": {id: "AAYANSH", c: "#808080", name: "Ragebait", d: "Buff after Backup is used."},
  "Brat Advik": {id: "ADVIK", c: "#ff4500", name: "Over-confidence", d: "20% dodge special moves."},
  "Lord Keshav": {id: "KESHAV", c: "#ffffff", name: "God's Touch", d: "All trainer abilities combined."}
};

// Game Variables
let p1,p2,turn=1,curM,selectionPhase=0,towerLevel=1,towerList=[],towerInventory=null,towerEvoStage=0,potionBlock={p1:0,p2:0,dmgReduction:{p1:0,p2:0}};

window.onload=()=>{loadBeasts();};

function loadBeasts(){
  const r=document.getElementById('roster');r.innerHTML="";
  ["Paricheymon","Debosmitamon","Smitimon"].forEach(n=>{
    r.innerHTML+=`<div class="card" onclick="pick('${n}')" style="--b-color:${db[n].color}"><div class="beast-name">${n}</div><div class="beast-type">${db[n].type}</div></div>`;
  });
}

function loadTrainers(){
  const r=document.getElementById('roster');r.innerHTML="";
  Object.keys(trainers).forEach(n=>{
    if(n==="Lord Keshav")return;
    r.innerHTML+=`<div class="card" onclick="pickTrainer('${n}')" style="--b-color:${trainers[n].c}"><div class="beast-name">${n}</div><div class="beast-type" style="color:#fff; margin-bottom: 2px;">${trainers[n].name}</div><div style="font-size:0.5rem; color:#aaa; line-height:1;">${trainers[n].d}</div></div>`;
  });
}

function pick(n){
  let p={...db[n],n,cur:db[n].hp,stun:0,bleed:0,weak:0,shield:0,shieldLock:false,buff:0,accMod:0,evasion:0,used:[],lastMoveName:null,revived:0,hasDealtDmg:false,items:{HP:1,ANTI:1,BUFF:1,BKUP:1},trainer:null,trId:null,evoPath:n};
  p1=p;
  showTowerIntro(n);
}

function showTowerIntro(bn){
  document.getElementById('dialog-box').style.display='flex';
  document.getElementById('dialog-text').innerHTML=`You dare to climb the Untameable tower of the DPS-122 with only one Campanian-${bn}. Do you think you can win it, No. Many came and many passed by none managed to defeat this tower. NONE WAS ABLE TO FACE THE WRATH OF THIS TOWER and then there is YOU, a NOBODY.`;
  document.getElementById('dialog-buttons').innerHTML='<button class="dialog-btn" onclick="closeTowerIntro()">BEGIN</button>';
}

function closeTowerIntro(){
  document.getElementById('dialog-box').style.display='none';
  document.getElementById('sel-hint').innerText="[ SELECT YOUR TRAINER ]";
  selectionPhase=1;
  loadTrainers();
}

function showEvolutionDialog(newName){
  document.getElementById('dialog-box').style.display='flex';
  document.getElementById('dialog-text').innerHTML=`It seems the beast has grown a fond liking towards you, it won't accept defeat for your honour, it won't die but evolve into something new into a- ${newName}`;
  document.getElementById('dialog-buttons').innerHTML='<button class="dialog-btn" onclick="closeEvolutionDialog()">CONTINUE</button>';
}

function closeEvolutionDialog(){document.getElementById('dialog-box').style.display='none';}

function pickTrainer(n){
  const tr=trainers[n];
  p1.trainer=n;p1.trId=tr.id;p1.trColor=tr.c;
  initTower();
}

function showFloor10Victory(){
  document.getElementById('dialog-box').style.display='flex';
  document.getElementById('dialog-text').innerHTML=`You are strong, brave and undoubtably the victor. You have defeated me- LORD KESHAV the spirit of this Tower but ohh you brave warrior, I have a request for you, a request for one last fight. DO YOU ACCEPT?`;
  document.getElementById('dialog-buttons').innerHTML='<button class="dialog-btn" onclick="acceptVibhamon()">YES</button><button class="dialog-btn" onclick="refuseVibhamon()">NO</button>';
}

function acceptVibhamon(){
  document.getElementById('dialog-box').style.display='none';
  setTimeout(()=>{
    document.getElementById('dialog-box').style.display='flex';
    document.getElementById('dialog-text').innerHTML=`Ohh you brave warrior thank you for hearing my plea. In the basement of tower there is a beast, UNTAMED, UNSEEN, UNTOUCHED, but only HEARD OF- VIBHAMON. Once I see her I won't be able to do anything but I will become her trainer. It will force me to use my ability- GOD'S TOUCH. Let's go`;
    document.getElementById('dialog-buttons').innerHTML='<button class="dialog-btn" onclick="startVibhamonBattle()">FIGHT</button>';
  },100);
}

function refuseVibhamon(){
  document.getElementById('dialog-box').style.display='none';
  setTimeout(()=>{
    document.getElementById('dialog-box').style.display='flex';
    document.getElementById('dialog-text').innerHTML=`A wise choice indeed, congrats on defeating me and my army. Your name will echo in the walls of this tower as the one and only man to defeat GOD'S PLAN`;
    document.getElementById('dialog-buttons').innerHTML='<button class="dialog-btn" onclick="location.href=\'index.html\'">EXIT</button>';
  },100);
}

function startVibhamonBattle(){
  document.getElementById('dialog-box').style.display='none';
  towerLevel=11;
  startTowerMatch();
}

function showVibhamonVictory(){
  document.getElementById('dialog-box').style.display='flex';
  document.getElementById('dialog-text').innerHTML=`......... You are the HERO, a force that no one can stop, a true legend, the TRUE ALMIGHTY. Thank you. Ps Tell ur Name to the dev so that your name can be enscribed in the HALL OF FAME. And since You have made this far i can tell you- The dev really likes Naysha.`;
  document.getElementById('dialog-buttons').innerHTML='<button class="dialog-btn" onclick="location.href=\'index.html\'">EXIT</button>';
}

function showDefeatDialog(){
  document.getElementById('dialog-box').style.display='flex';
  document.getElementById('dialog-text').innerHTML=`You are no match for me or my TOWER, you pathetic weakling courage less soul. Now run away, run as much as you want but you won't be able to run from the humiliation I had brought to you`;
  document.getElementById('dialog-buttons').innerHTML='<button class="dialog-btn" onclick="location.reload()">RETRY</button><button class="dialog-btn" onclick="location.href=\'index.html\'">MENU</button>';
}

function initTower(){
  towerList=Object.keys(db).filter(x=>x!==p1.n&&x!=="Vibhamon").sort(()=>0.5-Math.random());
  if(p1.trId==="SHUBHAN")p1.items.HP+=1;
  if(p1.trId==="NEIL")p1.items.BKUP=2;
  towerInventory={...p1.items};
  towerEvoStage=0;
  document.getElementById('selection-screen').style.display='none';
  document.getElementById('battle-screen').style.display='flex';
  document.getElementById('tower-level-ind').style.display='block';
  startTowerMatch();
}

function startTowerMatch(){
  if(towerLevel>11){showVibhamonVictory();return;}
  turn=1;
  p1.cur=p1.hp;
  p1.stun=0;p1.bleed=0;p1.weak=0;p1.shield=0;p1.shieldLock=false;p1.buff=0;p1.accMod=0;p1.evasion=0;p1.used=[];p1.revived=0;p1.hasDealtDmg=false;
  p1.items={...towerInventory};
  potionBlock={p1:0,p2:0,dmgReduction:{p1:0,p2:0}};
  
  let oppName;
  if(towerLevel===11){
    oppName="Vibhamon";
    p1.hp=p1.hp*2;
    p1.cur=p1.hp;
    p1.items={HP:5,ANTI:5,BUFF:5,BKUP:5};
  }else if(towerLevel<=9)oppName=towerList[towerLevel-1];
  else oppName="MonsinMon";
  
  let p={...db[oppName],n:oppName,cur:db[oppName].hp,stun:0,bleed:0,weak:0,shield:0,shieldLock:false,buff:0,accMod:0,evasion:0,used:[],lastMoveName:null,revived:0,hasDealtDmg:false,items:{HP:1,ANTI:1,BUFF:1,BKUP:1},trainer:null,trId:null};
  
  if(towerLevel===11){
    p.trainer="Lord Keshav";
    p.trId="KESHAV";
    p.trColor="#ffffff";
  }else{
    const trKeys=Object.keys(trainers).filter(k=>k!=="Lord Keshav");
    const rndTr=trainers[trKeys[Math.floor(Math.random()*trKeys.length)]];
    p.trainer=Object.keys(trainers).find(key=>trainers[key]===rndTr);
    p.trId=rndTr.id;p.trColor=rndTr.c;
  }
  
  if(towerLevel!==11){
    p.hp+=(towerLevel*2);
  }
  
  let bossTitle="";
  if(towerLevel===5){p.hp+=10;p.str+=1;bossTitle=" [MINI-BOSS]";}
  if(towerLevel===7){p.hp+=15;p.str+=2;bossTitle=" [MEGA-BOSS]";}
  if(towerLevel===10){p.hp+=25;p.str+=3;bossTitle=" [FINAL BOSS]";}
  if(towerLevel===11){bossTitle=" [ULTIMATE BOSS]";}
  
  p.cur=p.hp;
  p2=p;
  
  document.getElementById('tower-level-ind').innerText=towerLevel===11?`BASEMENT${bossTitle}`:`FLOOR ${towerLevel}/10${bossTitle}`;
  document.getElementById('tower-level-ind').style.color=(towerLevel===5||towerLevel===7||towerLevel===10||towerLevel===11)?'#f00':'#fff';
  
  if(p.trId==="SHUBHAN")p.items.HP+=1;
  if(p.trId==="NEIL")p.items.BKUP=2;
  
  setupVisuals();
  showMain();
}

function traderPick(item){
  towerInventory[item]++;
  document.getElementById('trader-screen').style.display='none';
  document.getElementById('battle-screen').style.display='flex';
  towerLevel++;
  startTowerMatch();
}

function setupVisuals(){
  document.getElementById('p1-n').innerText=p1.n;
  document.getElementById('p1-n').style.color=p1.color;
  document.getElementById('p2-n').innerText=p2.n;
  document.getElementById('p2-n').style.color=p2.color;
  document.getElementById('s1').innerText=p1.n[0];
  document.getElementById('s2').innerText=p2.n[0];
  document.getElementById('s1').style.setProperty('--b-color',p1.color);
  document.getElementById('s2').style.setProperty('--b-color',p2.color);
  update();
  
  let thiefMsg="";
  if(p1.trId==="RISHIT")thiefMsg+=stealItem(p1,p2,"P1");
  if(p2.trId==="RISHIT")thiefMsg+=stealItem(p2,p1,"P2");
  if(thiefMsg){
    const t=document.getElementById('ticker');
    t.innerHTML=`<div class='crit-text' style='color:#ff6600;'>${thiefMsg}</div>`;
    setTimeout(()=>{t.innerHTML="";showMain();},2500);
  }else{showMain();}
}

function stealItem(thief,victim,tag){
  const avail=Object.keys(victim.items).filter(k=>victim.items[k]>0);
  if(avail.length>0){
    const s=avail[Math.floor(Math.random()*avail.length)];
    victim.items[s]--;thief.items[s]++;
    return `${tag} CHOR STOLE ${s.replace('_',' ')}! `;
  }return "";
}

function update(){
  [p1,p2].forEach((p,i)=>{
    let id=i+1;
    document.getElementById(`p${id}-bar`).style.width=(Math.max(0,p.cur)/p.hp*100)+"%";
    document.getElementById(`p${id}-bar`).style.setProperty('--b-color',p.color);
    document.getElementById(`p${id}-hp-num`).innerText=`CORE: ${Math.max(0,Math.floor(p.cur))}/${p.hp}`;
    document.getElementById(`p${id}-sh`).innerText=p.shield>0?`SHIELD:${p.shield}`:(p.shieldLock?"[LOCK]":"");
    let st=[];
    if(p.bleed>0)st.push(`BLEED(${p.bleed})`);
    if(p.weak>0)st.push(`WEAK(${p.weak})`);
    if(p.buff>0)st.push("BUFFED");
    if(p.evasion>0)st.push("EVA");
    document.getElementById(`p${id}-status`).innerText=st.join(" | ");
    document.getElementById(`p${id}-trainer`).innerText=`TR: ${p.trainer}`;
    document.getElementById(`p${id}-trainer`).style.color=p.trColor;
    
    const potBlock=i===0?potionBlock.p1:potionBlock.p2;
    document.getElementById(`p${id}-potion-block`).innerText=potBlock>0?`POTION BLOCKED (${potBlock})`:"";
  });
  
  document.getElementById('p1-n').innerText=p1.n;
  document.getElementById('p1-n').style.color=p1.color;
  document.getElementById('s1').innerText=p1.n[0];
  document.getElementById('s1').style.setProperty('--b-color',p1.color);
}

function showMain(){
  document.getElementById('ticker').innerText="";
  if(turn===2){setTimeout(cpuAI,1000);return;}
  document.getElementById('cat-att').style.display='block';
  document.getElementById('cat-itm').style.display='block';
  for(let i=0;i<4;i++){
    document.getElementById('b'+i).style.display='none';
    document.getElementById('b'+i).classList.remove('selected');
  }
  document.getElementById('exec-trigger').style.display='none';
  document.getElementById('s1').classList.toggle('active-sprite',turn===1);
  document.getElementById('s2').classList.toggle('active-sprite',turn===2);
}

function showSub(m){
  document.getElementById('cat-att').style.display='none';
  document.getElementById('cat-itm').style.display='none';
  const a=turn===1?p1:p2;
  const o=turn===1?p2:p1;
  const potBlock=turn===1?potionBlock.p1:potionBlock.p2;
  
  if(m==='ATTACK'){
    a.moves.forEach((mv,i)=>{
      let b=document.getElementById('b'+i);
      b.style.display='block';
      b.innerText=mv.n;
      b.disabled=(a.used.includes(mv.n)||(mv.t==="SHIELD"&&a.shieldLock));
      b.onclick=()=>prep(mv,i,false);
    });
  }else{
    const itms=[{n:"HP POTION",t:"HP",v:a.items.HP,d:"+7 HP"},{n:"ANTI",t:"ANTI",v:a.items.ANTI,d:"Clear status"},{n:"BUFF",t:"BUFF",v:a.items.BUFF,d:"+3 DMG & +10% ACC"},{n:"BACKUP",t:"BKUP",v:a.items.BKUP,d:"Revive Life"}];
    itms.forEach((it,i)=>{
      let b=document.getElementById('b'+i);
      b.style.display='block';
      b.innerText=`${it.n}(${it.v})`;
      b.disabled=(it.v<=0||(o.trId==="NAYSHA"&&(it.t==="HP"||it.t==="ANTI"))||(potBlock>0&&(it.t==="HP"||it.t==="ANTI")));
      b.onclick=()=>prep(it,i,true);
    });
  }
}

function prep(m,i,isItm){
  const a=turn===1?p1:p2;
  const o=turn===1?p2:p1;
  curM={...m,isItem:isItm};
  
  for(let j=0;j<4;j++)document.getElementById('b'+j).classList.remove('selected');
  if(i!==-1)document.getElementById('b'+i).classList.add('selected');
  
  document.getElementById('c-title').innerText=m.n;
  
  let acc=m.p||100;
  let mods=a.accMod;
  const isSp=(m.t==="DMG"||m.t==="RAND_DMG"||m.t==="STUN"||m.t==="SILENCE"||m.t==="PERCENT"||m.t==="SPEECH_STUN");
  
  if(!isItm&&o.trId==="UDAY"&&isSp&&m.t!=="WIS"&&m.t!=="SHIELD")mods-=15;
  if(!isItm&&a.trId==="CHAHAK"&&isSp)mods+=10;
  if(!isItm&&o.trId==="KESHAV"&&isSp&&m.t!=="WIS"&&m.t!=="SHIELD")mods-=15;
  if(!isItm&&a.trId==="KESHAV"&&isSp)mods+=10;
  
  document.getElementById('c-acc').innerText=(isItm?100:Math.min(100,acc+mods))+"%";
  
  let d=m.val||"EFF";
  if(m.t==="RISK")d=10;
  if(a.trId==="CHAHAK"&&isSp&&!isNaN(d))d=parseInt(d)+2;
  if(a.trId==="KESHAV"&&isSp&&!isNaN(d))d=parseInt(d)+2;
  if(towerLevel===11&&turn===1&&!isNaN(d))d=parseInt(d)+3;
  
  document.getElementById('c-dmg').innerText=d;
  document.getElementById('c-desc').innerText=`// ${m.d||"Active"}`;
  
  if(turn===1)document.getElementById('exec-trigger').style.display='block';
}

function handleAction(){
  const att=turn===1?p1:p2;
  const def=turn===1?p2:p1;
  const t=document.getElementById('ticker');
  const sDef=document.getElementById(turn===1?'s2':'s1');
  
  document.getElementById('exec-trigger').style.display='none';
  
  let msg="";
  const attDmgRed=turn===1?potionBlock.dmgReduction.p1:potionBlock.dmgReduction.p2;
  
  if(curM.isItem){
    if(curM.t==='HP')att.cur=Math.min(att.hp,att.cur+7);
    if(curM.t==='ANTI'){att.stun=0;att.bleed=0;att.weak=0;}
    if(curM.t==='BUFF'){att.buff=3;att.accMod=10;}
    att.items[curM.t]--;
    t.innerHTML="<div class='crit-text' style='color:#0f0; border-color:#0f0'>[ FIXED ]</div>";
  }else{
    let hit=(curM.p||100)+att.accMod;
    const isSp=(curM.t==="DMG"||curM.t==="RAND_DMG"||curM.t==="STUN"||curM.t==="SILENCE"||curM.t==="PERCENT"||curM.t==="SPEECH_STUN");
    
    if(def.trId==="UDAY"&&isSp&&curM.t!=="WIS"&&curM.t!=="SHIELD")hit-=15;
    if(att.trId==="CHAHAK"&&isSp)hit+=10;
    if(def.trId==="KESHAV"&&isSp&&curM.t!=="WIS"&&curM.t!=="SHIELD")hit-=15;
    if(att.trId==="KESHAV"&&isSp)hit+=10;
    if(def.evasion>0){hit-=50;def.evasion=0;}
    
    let dodged=false;
    if(def.trId==="ADVIK"&&(isSp||att.buff>0)){if(Math.random()<0.2)dodged=true;}
    if(def.trId==="KESHAV"&&(isSp||att.buff>0)){if(Math.random()<0.2)dodged=true;}
    
    if(Math.random()*100>hit||dodged){
      t.innerHTML=dodged?"<div class='crit-text' style='color:#ff4500;'>[ DODGED ]</div>":"<div class='crit-text' style='color:#888; border-color:#888'>[ MISSED ]</div>";
      att.accMod=0;
    }else{
      let d=(curM.val||0);
      if(curM.t==="RAND_DMG")d=Math.floor(Math.random()*(curM.max-curM.min+1))+curM.min;
      if(curM.t==="RISK"){att.cur=Math.max(1,att.cur-8);d=10;}
      if(curM.t==="WIS")d=(def.cur>att.cur)?Math.floor(def.cur/2):0;
      if(curM.t==="DS")d=(def.cur<(def.hp*0.3))?def.cur:2;
      if(curM.t==="PERCENT")d=Math.floor(att.cur*0.5);
      if(curM.t==="SPEECH_STUN"){def.stun=3;d=0;}
      if(curM.t==="WARRANT"){
        if(def.cur<=20){
          if(turn===1){potionBlock.p2=5;potionBlock.dmgReduction.p2=2;}
          else{potionBlock.p1=5;potionBlock.dmgReduction.p1=2;}
          msg="[ WARRANT ACTIVATED ]";d=0;
        }
      }
      if(curM.t==="HEAL"){att.cur=Math.min(att.hp,att.cur+3);d=0;msg="[ HEALED ]";}
      if(curM.t==="SWAP"){let tmp=att.cur;att.cur=def.cur;def.cur=tmp;d=0;msg="[ SWAPPED ]";}
      if(curM.t==="BLEED"||curM.t==="BLEED_RAND")def.bleed=3;
      if(curM.t==="WEAK")def.weak=3;
      if(curM.t==="STUN"||curM.t==="SILENCE")def.stun=(curM.n==="Silence"||curM.n==="Intimidate"||curM.n==="Bald Shine")?1:2;
      if(curM.t==="EVA"){att.evasion=1;msg="[ EVASIVE ]";}
      
      if(att.weak>0&&d>0)d=Math.floor(d/2);
      if(attDmgRed>0&&d>0)d=Math.max(0,d-attDmgRed);
      if(att.trId==="CHAHAK"&&isSp&&d>0)d+=2;
      if(att.trId==="KESHAV"&&isSp&&d>0)d+=2;
      if(towerLevel===11&&turn===1&&d>0)d+=3;
      
      if(def.shield>0&&(d>0||curM.t==="WRATH")){
        if(att.buff>0){def.shield=0;def.shieldLock=true;msg="<div class='crit-text' style='color:#ff00ea; border-color:#ff00ea'>[ BROKEN ]</div>";}
        else if(curM.t==="WRATH"||curM.t==="RISK"){def.shield=0;msg="<div class='crit-text' style='color:#ff00ea; border-color:#ff00ea'>[ PIERCED ]</div>";}
        else{d=0;def.shield--;msg="<div class='crit-text' style='color:#00f3ff; border-color:#00f3ff'>[ BLOCKED ]</div>";}
      }
      
      if(att.buff>0&&d>0){d+=3;if(!dodged)att.buff=0;}
      att.accMod=0;
      
      if(curM.t==="WRATH"){def.cur=1;d=0;msg="[ WRATH ]";}
      if(curM.t==="LEECH"){att.cur=Math.min(att.hp,att.cur+d);}
      if(curM.t==="SHIELD"&&!att.shieldLock){att.shield=3;msg="[ SHIELD UP ]";}
      
      def.cur=Math.max(0,def.cur-d);
      if(d>0){sDef.classList.add('shake');att.hasDealtDmg=true;}
      
      if(def.trId==="ADYA"&&(d>=0)){att.cur=Math.max(0,att.cur-1);msg=msg?msg+" + [RECOIL]":"[ RECOIL ]";}
      if(def.trId==="KESHAV"&&(d>=0)){att.cur=Math.max(0,att.cur-1);msg=msg?msg+" + [RECOIL]":"[ RECOIL ]";}
      
      t.innerHTML=msg||`<div class='crit-text'>-[ ${Math.floor(d)} ]</div>`;
    }
    
    if(curM.once)att.used.push(curM.n);
    att.lastMoveName=curM.n;
  }
  
  if(turn===2&&p1.cur>0&&p1.cur<=5&&towerLevel!==11){
    tryEvolution();
  }
  
  update();
  setTimeout(checkDeath,1000);
}

function tryEvolution(){
  if(!evoTree[p1.evoPath])return;
  let targetName="";
  if(towerLevel>=3&&towerEvoStage===0)targetName=evoTree[p1.evoPath][0];
  else if(towerLevel>=7&&towerEvoStage===1)targetName=evoTree[p1.evoPath][1];
  if(targetName){
    towerEvoStage++;
    const newForm=db[targetName];
    p1.n=targetName;p1.moves=newForm.moves;p1.type=newForm.type;p1.color=newForm.color;
    p1.str=newForm.str;p1.spd=newForm.spd;p1.hp=newForm.hp;p1.cur=p1.hp;
    
    const s1=document.getElementById('s1');
    s1.classList.add('evo-flash');
    document.getElementById('ticker').innerHTML=`<div class='crit-text' style='color:#fff; border-color:#fff'>[ EVOLUTION ]</div>`;
    setTimeout(()=>{
      s1.classList.remove('evo-flash');
      showEvolutionDialog(targetName);
    },1500);
    update();
  }
}

function cpuAI(){
  const att=p2,def=p1;
  const canH=(att.items.HP>0&&def.trId!=="NAYSHA");
  const canA=(att.items.ANTI>0&&def.trId!=="NAYSHA");
  const canB=(att.items.BUFF>0);
  let choice=null,isItem=false;
  
  const killMove=att.moves.find(m=>{
    let d=m.val||0;
    if(m.t==="RISK")d=10;
    if(m.t==="DMG"||m.t==="RAND_DMG"){
      if(att.buff>0)d+=3;
      if(att.trId==="CHAHAK")d+=2;
      if(att.trId==="KESHAV")d+=2;
    }
    return d>=def.cur&&(m.p||100)>60&&!att.used.includes(m.n);
  });
  
  if(killMove){
    choice=killMove;
  }else{
    if(att.cur<=8&&canH&&att.cur<att.hp){choice={n:"HP POTION",t:"HP",d:"+7 HP"};isItem=true;}
    else if((att.weak>0||att.bleed>1)&&canA){choice={n:"ANTI",t:"ANTI",d:"Clear status"};isItem=true;}
    else if(att.cur>15&&canB&&att.buff===0){choice={n:"BUFF",t:"BUFF",d:"+3 DMG"};isItem=true;}
    else{
      let mvs=att.moves.filter(m=>!att.used.includes(m.n)&&!(m.t==="SHIELD"&&att.shieldLock));
      
      if(att.lastMoveName&&mvs.length>1){
        const others=mvs.filter(m=>m.n!==att.lastMoveName);
        if(others.length>0)mvs=others;
      }
      
      const stunMove=mvs.find(m=>(m.t==="STUN"||m.t==="SILENCE")&&def.stun===0);
      const breakMove=mvs.find(m=>(m.t==="WRATH"||m.t==="RISK")&&def.shield>0);
      const bigHit=mvs.sort((a,b)=>(b.val||0)-(a.val||0))[0];
      
      choice=stunMove||breakMove||bigHit||mvs[Math.floor(Math.random()*mvs.length)];
    }
  }
  
  document.getElementById('ticker').innerHTML=`<div class='crit-text' style='color:var(--cyber-blue); border-color:var(--cyber-blue); font-size:1.5rem'>CPU USED: ${choice.n}</div>`;
  prep(choice,-1,isItem);
  setTimeout(()=>handleAction(),1500);
}

function checkDeath(){
  let dead=(p1.cur<=0)?p1:(p2.cur<=0?p2:null);
  if(dead){
    if(dead.items.BKUP>0){
      dead.revived++;
      let h=dead.revived===1?5:3;
      dead.cur=h;dead.items.BKUP--;dead.bleed=0;dead.stun=0;
      if(dead.trId==="AAYANSH"){dead.buff=3;dead.accMod=10;}
      if(dead.trId==="KESHAV"){dead.buff=3;dead.accMod=10;}
      update();
      document.getElementById('ticker').innerHTML=`<div class='crit-text' style='color:#0f0'>${dead.revived===2?"HE IS STILL THERE":"[ REBOOTING ]"}</div>`;
      
      if(dead===p1&&towerLevel!==11)setTimeout(tryEvolution,500);
      setTimeout(()=>endTurn(),1200);
    }else{
      if(dead===p1){
        showDefeatDialog();
      }else{
        towerInventory={...p1.items};
        document.getElementById('ticker').innerHTML=`<div class='crit-text' style='color:#0f0'>[ FLOOR CLEARED ]</div>`;
        setTimeout(()=>{
          if(towerLevel===10){
            document.getElementById('battle-screen').style.display='none';
            showFloor10Victory();
          }else if(towerLevel===11){
            document.getElementById('battle-screen').style.display='none';
            showVibhamonVictory();
          }else if(towerLevel===3||towerLevel===6||towerLevel===9){
            document.getElementById('battle-screen').style.display='none';
            document.getElementById('trader-screen').style.display='flex';
          }else{
            towerLevel++;
            startTowerMatch();
          }
        },2000);
      }
    }
  }else{
    setTimeout(()=>endTurn(),800);
  }
}

function endTurn(){
  const c=turn===1?p1:p2,o=turn===1?p2:p1;
  if(c.bleed>0&&c.cur>0){c.cur=Math.max(0,c.cur-1);c.bleed--;}
  if(c.trId==="NOEL"&&c.hasDealtDmg){o.cur=Math.max(0,o.cur-2);}
  if(c.trId==="KESHAV"&&c.hasDealtDmg){o.cur=Math.max(0,o.cur-2);}
  
  if(turn===1&&potionBlock.p1>0)potionBlock.p1--;
  if(turn===2&&potionBlock.p2>0)potionBlock.p2--;
  if(turn===1&&potionBlock.p1===0)potionBlock.dmgReduction.p1=0;
  if(turn===2&&potionBlock.p2===0)potionBlock.dmgReduction.p2=0;
  
  update();
  if(p1.cur<=0||p2.cur<=0){checkDeath();return;}
  if(c.weak>0)c.weak--;
  turn=turn===1?2:1;
  const n=turn===1?p1:p2;
  document.querySelectorAll('.sprite').forEach(s=>s.classList.remove('shake'));
  if(n.stun>0){
    n.stun--;
    update();
    document.getElementById('ticker').innerHTML="<div class='crit-text' style='color:#f00'>[ STUNNED ]</div>";
    setTimeout(()=>endTurn(),1000);
  }else{
    showMain();
  }
}
</script>
</body>
</html>
