<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Subsi ki Jang - Tower Mode</title>

<link rel="stylesheet" href="game-styles.css">

<style>
#dialog-box{
  position:absolute; inset:0; z-index:200;
  background:rgba(0,0,0,0.95);
  display:none; flex-direction:column;
  align-items:center; justify-content:center;
  padding:40px;
}
#dialog-text{
  color:#fff; font-size:1.2rem;
  max-width:800px; text-align:center;
  line-height:1.8; margin-bottom:30px;
  text-transform:none;
}
.dialog-btn{
  background:#000; color:var(--cyber-blue);
  border:2px solid var(--cyber-blue);
  padding:15px 40px; cursor:pointer;
  font-weight:900; font-family:'Courier New';
  margin:0 10px;
}
.dialog-btn:hover{background:var(--cyber-blue);color:#000}

#tower-level-ind{
  position:absolute; top:10px; left:50%;
  transform:translateX(-50%);
  font-size:1.2rem; color:#fff;
  text-shadow:0 0 10px var(--cyber-blue);
  display:none;
}

#trader-screen{
  position:absolute; inset:0; z-index:100;
  background:rgba(0,0,0,0.95);
  display:none; flex-direction:column;
  align-items:center; justify-content:center;
}

.trade-opt{
  border:1px solid gold; color:gold;
  padding:20px; width:300px;
  margin-top:10px; cursor:pointer;
  text-align:center;
}
.trade-opt:hover{background:gold;color:#000}
</style>
</head>

<body>
<div id="crt-overlay"></div>

<div id="game-window">

<button id="back-btn" onclick="location.href='index.html'">‚Üê BACK TO MENU</button>

<div id="tower-level-ind">FLOOR 1</div>

<!-- DIALOG -->
<div id="dialog-box">
  <div id="dialog-text"></div>
  <div id="dialog-buttons"></div>
</div>

<!-- SELECTION -->
<div id="selection-screen">
  <h1>TOWER MODE</h1>
  <div id="sel-hint">[ SELECT STARTER UNIT ]</div>
  <div class="grid" id="roster"></div>
</div>

<!-- TRADER -->
<div id="trader-screen">
  <h2 style="color:gold;font-size:3rem">MYSTIC TRADER</h2>
  <p style="color:#aaa">"Take this. You‚Äôll need it."</p>
  <div class="trade-opt" onclick="pickTrade('HP')">HP POTION +1</div>
  <div class="trade-opt" onclick="pickTrade('ANTI')">ANTI SERUM +1</div>
  <div class="trade-opt" onclick="pickTrade('BUFF')">BUFF DATA +1</div>
  <div class="trade-opt" onclick="pickTrade('BKUP')">BACKUP DRIVE +1</div>
</div>

<!-- BATTLE -->
<div id="battle-screen" style="display:none">
  <div id="ticker"></div>
  <div id="arena-bg">
    <div id="s1" class="sprite"></div>
    <div id="s2" class="sprite"></div>
  </div>
  <button id="exec-trigger" onclick="handleAction()">INITIATE STRIKE</button>
</div>

</div>

<script src="game-data.js"></script>

<script>
/* ======================
   TOWER MODE ENGINE
   ====================== */

let p1,p2,turn=1,curM;
let towerLevel=1;
let towerOrder=[];
let towerInventory;
let evoDone=false;

/* ---------- INIT ---------- */
window.onload=()=>{
  loadBeasts();
};

/* ---------- SELECTION ---------- */
function loadBeasts(){
  const r=document.getElementById('roster');
  r.innerHTML="";
  ["Paricheymon","Debosmitamon","Smitimon"].forEach(n=>{
    r.innerHTML+=`
      <div class="card" onclick="pickBeast('${n}')"
      style="--b-color:${db[n].color}">
        <div class="beast-name">${n}</div>
        <div class="beast-type">${db[n].type}</div>
      </div>`;
  });
}

function pickBeast(n){
  const hp=Math.max(1,db[n].hp-10); // üî• TOWER HP NERF
  p1={...db[n],n,hp,cur:hp,used:[],items:{HP:1,ANTI:1,BUFF:1,BKUP:1}};
  introDialog(n);
}

/* ---------- DIALOG ---------- */
function introDialog(n){
  showDialog(
    `You enter the Tower of DPS-122 with only ${n}. Many failed. None returned.`,
    [{t:"BEGIN",f:selectTrainer}]
  );
}

function selectTrainer(){
  document.getElementById("sel-hint").innerText="[ SELECT TRAINER ]";
  const r=document.getElementById("roster");
  r.innerHTML="";
  Object.keys(trainers).forEach(n=>{
    if(n==="Lord Keshav")return;
    r.innerHTML+=`
      <div class="card" onclick="pickTrainer('${n}')"
      style="--b-color:${trainers[n].c}">
        <div class="beast-name">${n}</div>
        <div class="beast-type">${trainers[n].name}</div>
      </div>`;
  });
}

function pickTrainer(n){
  p1.trainer=n;
  p1.trId=trainers[n].id;
  startTower();
}

function showDialog(text,btns){
  const d=document.getElementById("dialog-box");
  document.getElementById("dialog-text").innerHTML=text;
  const b=document.getElementById("dialog-buttons");
  b.innerHTML="";
  btns.forEach(x=>{
    const bt=document.createElement("button");
    bt.className="dialog-btn";
    bt.innerText=x.t;
    bt.onclick=()=>{d.style.display="none";x.f();};
    b.appendChild(bt);
  });
  d.style.display="flex";
}

/* ---------- TOWER ---------- */
function startTower(){
  document.getElementById("selection-screen").style.display="none";
  document.getElementById("battle-screen").style.display="block";
  document.getElementById("tower-level-ind").style.display="block";

  towerOrder=Object.keys(db).filter(x=>x!==p1.n && x!=="Vibhamon");
  towerOrder.sort(()=>0.5-Math.random());

  towerInventory={...p1.items};
  nextFloor();
}

function nextFloor(){
  turn=1;
  p1.cur=p1.hp;
  p1.items={...towerInventory};

  const name=towerLevel===11?"Vibhamon":towerOrder[towerLevel-1];
  let hp=Math.max(1,db[name].hp-10 + towerLevel*3);
  p2={...db[name],n:name,hp,cur:hp,used:[],items:{HP:1,ANTI:1,BUFF:1,BKUP:1}};

  document.getElementById("tower-level-ind").innerText=
    towerLevel===11?"BASEMENT":"FLOOR "+towerLevel;

  updateSprites();
}

/* ---------- BATTLE ---------- */
function handleAction(){
  const a=turn===1?p1:p2;
  const o=turn===1?p2:p1;
  const mv=a.moves[Math.floor(Math.random()*a.moves.length)];
  o.cur-=mv.val||3;
  ticker(`${a.n} used ${mv.n}`);
  if(o.cur<=0){victory();return;}
  turn=turn===1?2:1;
}

function victory(){
  if(towerLevel===10){
    showDialog("You have reached the peak.",[{t:"CONTINUE",f:()=>{towerLevel++;nextFloor();}}]);
    return;
  }
  if(towerLevel===11){
    showDialog("You defeated Vibhamon. You are legend.",[{t:"EXIT",f:()=>location.href="index.html"}]);
    return;
  }
  document.getElementById("battle-screen").style.display="none";
  document.getElementById("trader-screen").style.display="flex";
}

function pickTrade(i){
  towerInventory[i]++;
  document.getElementById("trader-screen").style.display="none";
  document.getElementById("battle-screen").style.display="block";
  towerLevel++;
  nextFloor();
}

/* ---------- UI ---------- */
function ticker(t){
  const el=document.getElementById("ticker");
  el.innerHTML=t;
  setTimeout(()=>el.innerHTML="",1200);
}

function updateSprites(){
  document.getElementById("s1").innerText=p1.n[0];
  document.getElementById("s2").innerText=p2.n[0];
}
</script>

</body>
</html>
