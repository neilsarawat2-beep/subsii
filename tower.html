<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Subsi ki Jang - Tower Mode</title>
<link rel="stylesheet" href="game-styles.css">
<style>
#dialog-box {position: absolute; inset: 0; z-index: 200; background: rgba(0,0,0,0.95); display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px;}
#dialog-text {color: #fff; font-size: clamp(0.9rem, 2vw, 1.2rem); text-align: center; max-width: 800px; line-height: 1.8; margin-bottom: 20px; text-transform: none;}
.dialog-btn {background: #000; color: var(--cyber-blue); border: 2px solid var(--cyber-blue); padding: clamp(10px, 2vw, 15px) clamp(20px, 3vw, 40px); cursor: pointer; font-family: 'Courier New'; font-weight: 900; margin: 5px; font-size: clamp(0.8rem, 1.8vw, 1.1rem); touch-action: manipulation;}
.dialog-btn:hover {background: var(--cyber-blue); color: #000;}
#tower-level-ind {position: absolute; top: 10px; left: 50%; transform: translateX(-50%); color: #fff; font-size: clamp(0.9rem, 2vw, 1.2rem); z-index: 20; text-shadow: 0 0 10px var(--cyber-blue); display: none;}
#trader-screen {position: absolute; inset: 0; z-index: 90; background: rgba(0,0,0,0.95); display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px;}
.trade-opt {border: 1px solid gold; color: gold; margin: 10px 0; padding: clamp(15px, 2vw, 20px); width: 90%; max-width: 300px; text-align: center; cursor: pointer; font-size: clamp(0.8rem, 1.8vw, 1rem); touch-action: manipulation;}
.trade-opt:hover {background: gold; color: #000;}
</style>
</head>
<body>
<div id="crt-overlay"></div>
<div id="game-window">
<button id="back-btn" onclick="location.href='index.html'">‚Üê BACK</button>
<div id="tower-level-ind">FLOOR 1</div>
<div id="dialog-box"><div id="dialog-text"></div><div id="dialog-buttons"></div></div>
<div id="selection-screen">
<h1>TOWER MODE</h1>
<div id="sel-hint" style="color:#555; letter-spacing:2px; margin-bottom:10px; font-size: clamp(0.7rem, 1.5vw, 0.9rem);">[ SELECT STARTER UNIT ]</div>
<div class="grid" id="roster"></div>
</div>
<div id="trader-screen">
<h2 style="color: gold; font-size: clamp(2rem, 5vw, 3rem); margin-bottom: 10px;">MYSTIC TRADER</h2>
<p style="color: #aaa; margin-bottom: 20px; text-transform: none;">"Take this. You'll need it for the upper floors..."</p>
<div class="trade-opt" onclick="traderPick('HP')">HP POTION (+1)</div>
<div class="trade-opt" onclick="traderPick('ANTI')">ANTI SERUM (+1)</div>
<div class="trade-opt" onclick="traderPick('BUFF')">BUFF DATA (+1)</div>
<div class="trade-opt" onclick="traderPick('BKUP')">BACKUP DRIVE (+1)</div>
</div>
<div id="battle-screen">
<div id="ticker"></div>
<div class="hud-top">
<div style="width: 45%;">
<div style="display:flex; justify-content:space-between; align-items:flex-end; flex-wrap: wrap;">
<span id="p1-n" style="font-weight:900; font-size: clamp(1rem, 2.5vw, 1.4rem);"></span>
<span id="p1-sh" style="color:var(--cyber-blue); font-size: clamp(0.6rem, 1.5vw, 0.8rem);"></span>
</div>
<div class="hp-rail"><div id="p1-bar" class="hp-bar"></div></div>
<div id="p1-hp-num" class="hp-val-text">CORE: --/--</div>
<div id="p1-status" style="font-size: clamp(0.5rem, 1.2vw, 0.6rem); color:#f00; margin-top:2px; min-height:10px;"></div>
<div id="p1-trainer" style="font-size: clamp(0.6rem, 1.3vw, 0.7rem); color:var(--cyber-blue); margin-top:2px;">TR: ---</div>
<div id="p1-potion-block" style="font-size: clamp(0.5rem, 1.2vw, 0.6rem); color:#f00; margin-top:2px; min-height:10px;"></div>
</div>
<div style="width: 45%; text-align: right;">
<div style="display:flex; justify-content:space-between; align-items:flex-end; flex-wrap: wrap;">
<span id="p2-sh" style="color:var(--cyber-blue); font-size: clamp(0.6rem, 1.5vw, 0.8rem);"></span>
<span id="p2-n" style="font-weight:900; font-size: clamp(1rem, 2.5vw, 1.4rem);"></span>
</div>
<div class="hp-rail" style="direction: rtl;"><div id="p2-bar" class="hp-bar"></div></div>
<div id="p2-hp-num" class="hp-val-text">CORE: --/--</div>
<div id="p2-status" style="font-size: clamp(0.5rem, 1.2vw, 0.6rem); color:#f00; margin-top:2px; min-height:10px;"></div>
<div id="p2-trainer" style="font-size: clamp(0.6rem, 1.3vw, 0.7rem); color:var(--cyber-blue); margin-top:2px;">TR: ---</div>
<div id="p2-potion-block" style="font-size: clamp(0.5rem, 1.2vw, 0.6rem); color:#f00; margin-top:2px; min-height:10px;"></div>
</div>
</div>
<div id="arena-bg"><div id="s1" class="sprite"></div><div id="s2" class="sprite"></div></div>
<button id="exec-trigger" onclick="handleAction()">INITIATE STRIKE</button>
<div id="control-panel">
<div id="console">
<div style="color:var(--cyber-blue); font-weight:900; border-bottom: 1px solid #333; margin-bottom:10px;">>> TACTICAL READOUT</div>
<div>MODULE: <span id="c-title" class="data-val">---</span></div>
<div>ACCURACY: <span id="c-acc" class="data-val">---</span></div>
<div style="color:var(--term-red)">EST DAMAGE: <span id="c-dmg" class="data-val">---</span></div>
<div id="c-desc" style="color:#666; font-size: clamp(0.6rem, 1.2vw, 0.7rem); margin-top: auto;">// AWAITING MODULE...</div>
</div>
<div id="move-grid">
<button class="move-btn" id="cat-att" onclick="showSub('ATTACK')">ATTACK SET</button>
<button class="move-btn" id="cat-itm" onclick="showSub('ITEMS')">ITEM POUCH</button>
<button class="move-btn" id="b0" style="display:none;"></button>
<button class="move-btn" id="b1" style="display:none;"></button>
<button class="move-btn" id="b2" style="display:none;"></button>
<button class="move-btn" id="b3" style="display:none;"></button>
</div>
</div>
</div>
</div>
<script src="game-data.js"></script>
<script>
let p1,p2,turn=1,curM,selectionPhase=0,towerLevel=1,towerList=[],towerInventory=null,towerEvoStage=0,potionBlock={p1:0,p2:0,dmgReduction:{p1:0,p2:0}};

window.onload=()=>{loadBeasts();};

function loadBeasts(){
  const r=document.getElementById('roster');r.innerHTML="";
  ["Paricheymon","Debosmitamon","Smitimon"].forEach(n=>{
    r.innerHTML+=`<div class="card" onclick="pick('${n}')" style="--b-color:${db[n].color}"><div class="beast-name">${n}</div><div class="beast-type">${db[n].type}</div></div>`;
  });
}

function loadTrainers(){
  const r=document.getElementById('roster');r.innerHTML="";
  Object.keys(trainers).forEach(n=>{
    if(n==="Lord Keshav")return;
    r.innerHTML+=`<div class="card" onclick="pickTrainer('${n}')" style="--b-color:${trainers[n].c}"><div class="beast-name">${n}</div><div class="beast-type" style="color:#fff; margin-bottom: 2px;">${trainers[n].name}</div><div style="font-size:0.5rem; color:#aaa; line-height:1;">${trainers[n].d}</div></div>`;
  });
}

function pick(n){
  let p={...db[n],n,cur:db[n].hp-10,stun:0,bleed:0,weak:0,shield:0,shieldLock:false,buff:0,accMod:0,evasion:0,used:[],lastMoveName:null,revived:0,hasDealtDmg:false,items:{HP:1,ANTI:1,BUFF:1,BKUP:1},trainer:null,trId:null,evoPath:n};
  p.hp=db[n].hp-10; // Reduce HP by 10 for tower
  p.cur=p.hp;
  p1=p;
  showTowerIntro(n);
}

function showTowerIntro(bn){
  document.getElementById('dialog-box').style.display='flex';
  document.getElementById('dialog-text').innerHTML=`You dare to climb the Untameable tower of the DPS-122 with only one Campanian-${bn}. Do you think you can win it, No. Many came and many passed by none managed to defeat this tower. NONE WAS ABLE TO FACE THE WRATH OF THIS TOWER and then there is YOU, a NOBODY.`;
  document.getElementById('dialog-buttons').innerHTML='<button class="dialog-btn" onclick="closeTowerIntro()">BEGIN</button>';
}

function closeTowerIntro(){
  document.getElementById('dialog-box').style.display='none';
  document.getElementById('sel-hint').innerText="[ SELECT YOUR TRAINER ]";
  selectionPhase=1;
  loadTrainers();
}

function showEvolutionDialog(newName){
  document.getElementById('dialog-box').style.display='flex';
  document.getElementById('dialog-text').innerHTML=`It seems the beast has grown a fond liking towards you, it won't accept defeat for your honour, it won't die but evolve into something new into a- ${newName}`;
  document.getElementById('dialog-buttons').innerHTML='<button class="dialog-btn" onclick="closeEvolutionDialog()">CONTINUE</button>';
}

function closeEvolutionDialog(){document.getElementById('dialog-box').style.display='none';}

function pickTrainer(n){
  const tr=trainers[n];
  p1.trainer=n;p1.trId=tr.id;p1.trColor=tr.c;
  initTower();
}

function showFloor10Victory(){
  document.getElementById('dialog-box').style.display='flex';
  document.getElementById('dialog-text').innerHTML=`You are strong, brave and undoubtably the victor. You have defeated me- LORD KESHAV the spirit of this Tower but ohh you brave warrior, I have a request for you, a request for one last fight. DO YOU ACCEPT?`;
  document.getElementById('dialog-buttons').innerHTML='<button class="dialog-btn" onclick="acceptVibhamon()">YES</button><button class="dialog-btn" onclick="refuseVibhamon()">NO</button>';
}

function acceptVibhamon(){
  document.getElementById('dialog-box').style.display='none';
  setTimeout(()=>{
    document.getElementById('dialog-box').style.display='flex';
    document.getElementById('dialog-text').innerHTML=`Ohh you brave warrior thank you for hearing my plea. In the basement of tower there is a beast, UNTAMED, UNSEEN, UNTOUCHED, but only HEARD OF- VIBHAMON. Once I see her I won't be able to do anything but I will become her trainer. It will force me to use my ability- GOD'S TOUCH. Let's go`;
    document.getElementById('dialog-buttons').innerHTML='<button class="dialog-btn" onclick="startVibhamonBattle()">FIGHT</button>';
  },100);
}

function refuseVibhamon(){
  document.getElementById('dialog-box').style.display='none';
  setTimeout(()=>{
    document.getElementById('dialog-box').style.display='flex';
    document.getElementById('dialog-text').innerHTML=`A wise choice indeed, congrats on defeating me and my army. Your name will echo in the walls of this tower as the one and only man to defeat GOD'S PLAN`;
    document.getElementById('dialog-buttons').innerHTML='<button class="dialog-btn" onclick="location.href=\'index.html\'">EXIT</button>';
  },100);
}

function startVibhamonBattle(){
  document.getElementById('dialog-box').style.display='none';
  towerLevel=11;
  startTowerMatch();
}

function showVibhamonVictory(){
  document.getElementById('dialog-box').style.display='flex';
  document.getElementById('dialog-text').innerHTML=`......... You are the HERO, a force that no one can stop, a true legend, the TRUE ALMIGHTY. Thank you. Ps I like Naysha`;
  document.getElementById('dialog-buttons').innerHTML='<button class="dialog-btn" onclick="location.href=\'index.html\'">EXIT</button>';
}

function showDefeatDialog(){
  document.getElementById('dialog-box').style.display='flex';
  document.getElementById('dialog-text').innerHTML=`You are no match for me or my TOWER, you pathetic weakling courage less soul. Now run away, run as much as you want but you won't be able to run from the humiliation I had brought to you`;
  document.getElementById('dialog-buttons').innerHTML='<button class="dialog-btn" onclick="location.reload()">RETRY</button><button class="dialog-btn" onclick="location.href=\'index.html\'">MENU</button>';
}

function initTower(){
  towerList=Object.keys(db).filter(x=>x!==p1.n&&x!=="Vibhamon").sort(()=>0.5-Math.random());
  if(p1.trId==="SHUBHAN")p1.items.HP+=1;
  if(p1.trId==="NEIL")p1.items.BKUP=2;
  towerInventory={...p1.items};
  towerEvoStage=0;
  document.getElementById('selection-screen').style.display='none';
  document.getElementById('battle-screen').style.display='flex';
  document.getElementById('tower-level-ind').style.display='block';
  startTowerMatch();
}

function startTowerMatch(){
  if(towerLevel>11){showVibhamonVictory();return;}
  turn=1;
  p1.cur=p1.hp;
  p1.stun=0;p1.bleed=0;p1.weak=0;p1.shield=0;p1.shieldLock=false;p1.buff=0;p1.accMod=0;p1.evasion=0;p1.used=[];p1.revived=0;p1.hasDealtDmg=false;
  p1.items={...towerInventory};
  potionBlock={p1:0,p2:0,dmgReduction:{p1:0,p2:0}};
  
  let oppName;
  if(towerLevel===11){
    oppName="Vibhamon";
    p1.hp=p1.hp*2;
    p1.cur=p1.hp;
    p1.items={HP:5,ANTI:5,BUFF:5,BKUP:5};
  }else if(towerLevel<=9)oppName=towerList[towerLevel-1];
  else oppName="MonsinMon";
  
  let p={...db[oppName],n:oppName,cur:db[oppName].hp,stun:0,bleed:0,weak:0,shield:0,shieldLock:false,buff:0,accMod:0,evasion:0,used:[],lastMoveName:null,revived:0,hasDealtDmg:false,items:{HP:1,ANTI:1,BUFF:1,BKUP:1},trainer:null,trId:null};
  
  if(towerLevel===11){
    p.trainer="Lord Keshav";
    p.trId="KESHAV";
    p.trColor="#ffffff";
  }else{
    const trKeys=Object.keys(trainers).filter(k=>k!=="Lord Keshav");
    const rndTr=trainers[trKeys[Math.floor(Math.random()*trKeys.length)]];
    p.trainer=Object.keys(trainers).find(key=>trainers[key]===rndTr);
    p.trId=rndTr.id;p.trColor=rndTr.c;
  }
  
  if(towerLevel!==11){
    p.hp=Math.max(10,p.hp-10+(towerLevel*2)); // Reduce HP by 10 for tower
  }
  
  let bossTitle="";
  if(towerLevel===5){p.hp+=10;p.str+=1;bossTitle=" [MINI-BOSS]";}
  if(towerLevel===7){p.hp+=15;p.str+=2;bossTitle=" [MEGA-BOSS]";}
  if(towerLevel===10){p.hp+=25;p.str+=3;bossTitle=" [FINAL BOSS]";}
  if(towerLevel===11){bossTitle=" [ULTIMATE BOSS]";}
  
  p.cur=p.hp;
  p2=p;
  
  document.getElementById('tower-level-ind').innerText=towerLevel===11?`BASEMENT${bossTitle}`:`FLOOR ${towerLevel}/10${bossTitle}`;
  document.getElementById('tower-level-ind').style.color=(towerLevel===5||towerLevel===7||towerLevel===10||towerLevel===11)?'#f00':'#fff';
  
  if(p.trId==="SHUBHAN")p.items.HP+=1;
  if(p.trId==="NEIL")p.items.BKUP=2;
  
  setupVisuals();
  showMain();
}

function traderPick(item){
  towerInventory[item]++;
  document.getElementById('trader-screen').style.display='none';
  document.getElementById('battle-screen').style.display='flex';
  towerLevel++;
  startTowerMatch();
}

function setupVisuals(){
  document.getElementById('p1-n').innerText=p1.n;
  document.getElementById('p1-n').style.color=p1.color;
  document.getElementById('p2-n').innerText=p2.n;
  document.getElementById('p2-n').style.color=p2.color;
  document.getElementById('s1').innerText=p1.n[0];
  document.getElementById('s2').innerText=p2.n[0];
  document.getElementById('s1').style.setProperty('--b-color',p1.color);
  document.getElementById('s2').style.setProperty('--b-color',p2.color);
  update();
  
  let thiefMsg="";
  if(p1.trId==="RISHIT")thiefMsg+=stealItem(p1,p2,"P1");
  if(p2.trId==="RISHIT")thiefMsg+=stealItem(p2,p1,"P2");
  if(thiefMsg){
    const t=document.getElementById('ticker');
    t.innerHTML=`<div class='crit-text' style='color:#ff6600;'>${thiefMsg}</div>`;
    setTimeout(()=>{t.innerHTML="";showMain();},2500);
  }else{showMain();}
}

function stealItem(thief,victim,tag){
  const avail=Object.keys(victim.items).filter(k=>victim.items[k]>0);
  if(avail.length>0){
    const s=avail[Math.floor(Math.random()*avail.length)];
    victim.items[s]--;thief.items[s]++;
    return `${tag} CHOR STOLE ${s.replace('_',' ')}! `;
  }return "";
}

function update(){
  [p1,p2].forEach((p,i)=>{
    let id=i+1;
    document.getElementById(`p${id}-bar`).style.width=(Math.max(0,p.cur)/p.hp*100)+"%";
    document.getElementById(`p${id}-bar`).style.setProperty('--b-color',p.color);
    document.getElementById(`p${id}-hp-num`).innerText=`CORE: ${Math.max(0,Math.floor(p.cur))}/${p.hp}`;
    document.getElementById(`p${id}-sh`).innerText=p.shield>0?`SHIELD:${p.shield}`:(p.shieldLock?"[LOCK]":"");
    let st=[];
    if(p.bleed>0)st.push(`BLEED(${p.bleed})`);
    if(p.weak>0)st.push(`WEAK(${p.weak})`);
    if(p.buff>0)st.push("BUFFED");
    if(p.evasion>0)st.push("EVA");
    document.getElementById(`p${id}-status`).innerText=st.join(" | ");
    document.getElementById(`p${id}-trainer`).innerText=`TR: ${p.trainer}`;
    document.getElementById(`p${id}-trainer`).style.color=p.trColor;
    
    const potBlock=i===0?potionBlock.p1:potionBlock.p2;
    document.getElementById(`p${id}-potion-block`).innerText=potBlock>0?`POTION BLOCKED (${potBlock})`:"";
  });
  
  document.getElementById('p1-n').innerText=p1.n;
  document.getElementById('p1-n').style.color=p1.color;
  document.getElementById('s1').innerText=p1.n[0];
  document.getElementById('s1').style.setProperty('--b-color',p1.color);
}

function showMain(){
  document.getElementById('ticker').innerText="";
  if(turn===2){setTimeout(cpuAI,1000);return;}
  document.getElementById('cat-att').style.display='block';
  document.getElementById('cat-itm').style.display='block';
  for(let i=0;i<4;i++){
    document.getElementById('b'+i).style.display='none';
    document.getElementById('b'+i).classList.remove('selected');
  }
  document.getElementById('exec-trigger').style.display='none';
  document.getElementById('s1').classList.toggle('active-sprite',turn===1);
  document.getElementById('s2').classList.toggle('active-sprite',turn===2);
}

function showSub(m){
  document.getElementById('cat-att').style.display='none';
  document.getElementById('cat-itm').style.display='none';
  const a=turn===1?p1:p2;
  const o=turn===1?p2:p1;
  const potBlock=turn===1?potionBlock.p1:potionBlock.p2;
  
  if(m==='ATTACK'){
    a.moves.forEach((mv,i)=>{
      let b=document.getElementById('b'+i);
      b.style.display='block';
      b.innerText=mv.n;
      b.disabled=(a.used.includes(mv.n)||(mv.t==="SHIELD"&&a.shieldLock));
      b.onclick=()=>prep(mv,i,false);
    });
  }else{
    const itms=[{n:"HP POTION",t:"HP",v:a.items.HP,d:"+7 HP"},{n:"ANTI",t:"ANTI",v:a.items.ANTI,d:"Clear status"},{n:"BUFF",t:"BUFF",v:a.items.BUFF,d:"+3 DMG & +10% ACC"},{n:"BACKUP",t:"BKUP",v:a.items.BKUP,d:"Revive Life"}];
    itms.forEach((it,i)=>{
      let b=document.getElementById('b'+i);
      b.style.display='block';
      b.innerText=`${it.n}(${it.v})`;
      b.disabled=(it.v<=0||(o.trId==="NAYSHA"&&(it.t==="HP"||it.t==="ANTI"))||(potBlock>0&&(it.t==="HP"||it.t==="ANTI")));
      b.onclick=()=>prep(it,i,true);
    });
  }
}

function prep(m,i,isItm){
  const a=turn===1?p1:p2;
  const o=turn===1?p2:p1;
  curM={...m,isItem:isItm};
  
  for(let j=0;j<4;j++)document.getElementById('b'+j).classList.remove('selected');
  if(i!==-1)document.getElementById('b'+i).classList.add('selected');
  
  document.getElementById('c-title').innerText=m.n;
  
  let acc=m.p||100;
  let mods=a.accMod;
  const isSp=(m.t==="DMG"||m.t==="RAND_DMG"||m.t==="STUN"||m.t==="SILENCE"||m.t==="PERCENT"||m.t==="SPEECH_STUN");
  
  if(!isItm&&o.trId==="UDAY"&&isSp&&m.t!=="WIS"&&m.t!=="SHIELD")mods-=15;
  if(!isItm&&a.trId==="CHAHAK"&&isSp)mods+=10;
  if(!isItm&&o.trId==="KESHAV"&&isSp&&m.t!=="WIS"&&m.t!=="SHIELD")mods-=15;
  if(!isItm&&a.trId==="KESHAV"&&isSp)mods+=10;
  
  document.getElementById('c-acc').innerText=(isItm?100:Math.min(100,acc+mods))+"%";
  
  let d=m.val||"EFF";
  if(m.t==="RISK")d=10;
  if(a.trId==="CHAHAK"&&isSp&&!isNaN(d))d=parseInt(d)+2;
  if(a.trId==="KESHAV"&&isSp&&!isNaN(d))d=parseInt(d)+2;
  
  document.getElementById('c-dmg').innerText=d;
  document.getElementById('c-desc').innerText=`// ${m.d||"Active"}`;
  
  if(turn===1)document.getElementById('exec-trigger').style.display='block';
}

function handleAction(){
  const att=turn===1?p1:p2;
  const def=turn===1?p2:p1;
  const t=document.getElementById('ticker');
  const sDef=document.getElementById(turn===1?'s2':'s1');
  
  document.getElementById('exec-trigger').style.display='none';
  
  let msg="";
  const attDmgRed=turn===1?potionBlock.dmgReduction.p1:potionBlock.dmgReduction.p2;
  
  if(curM.isItem){
    if(curM.t==='HP')att.cur=Math.min(att.hp,att.cur+7);
    if(curM.t==='ANTI'){att.stun=0;att.bleed=0;att.weak=0;}
    if(curM.t==='BUFF'){att.buff=3;att.accMod=10;}
    att.items[curM.t]--;
    t.innerHTML="<div class='crit-text' style='color:#0f0; border-color:#0f0'>[ FIXED ]</div>";
  }else{
    let hit=(curM.p||100)+att.accMod;
    const isSp=(curM.t==="DMG"||curM.t==="RAND_DMG"||curM.t==="STUN"||curM.t==="SILENCE"||curM.t==="PERCENT"||curM.t==="SPEECH_STUN");
    
    if(def.trId==="UDAY"&&isSp&&curM.t!=="WIS"&&curM.t!=="SHIELD")hit-=15;
    if(att.trId==="CHAHAK"&&isSp)hit+=10;
    if(def.trId==="KESHAV"&&isSp&&curM.t!=="WIS"&&curM.t!=="SHIELD")hit-=15;
    if(att.trId==="KESHAV"&&isSp)hit+=10;
    if(def.evasion>0){hit-=50;def.evasion=0;}
    
    let dodged=false;
    if(def.trId==="ADVIK"&&(isSp||att.buff>0)){if(Math.random()<0.2)dodged=true;}
    if(def.trId==="KESHAV"&&(isSp||att
