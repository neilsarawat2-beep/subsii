<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Subsi ki Jang – Online Mode</title>

<link rel="stylesheet" href="game-styles.css">
</head>

<body>
<div id="crt-overlay"></div>
<div id="game-window">

<button id="back-btn" onclick="goBack()">← BACK</button>

<!-- MODE -->
<div id="mode-selection" class="screen">
  <h1>ONLINE MODE</h1>
  <button onclick="selectGameMode('1v1')">1v1 MODE</button>
  <button onclick="selectGameMode('1v2')">1v2 MODE</button>
  <button onclick="selectGameMode('2v2')">2v2 MODE</button>
</div>

<!-- ROOM -->
<div id="room-screen" class="screen hidden">
  <h1 id="room-title"></h1>
  <button onclick="hostRoom()">HOST ROOM</button><br><br>
  <input id="join-code-input" placeholder="ROOM CODE">
  <button onclick="joinRoom()">JOIN</button>
  <div id="room-code-display" class="hidden">
    ROOM CODE: <span id="room-code"></span>
  </div>
  <div id="waiting-msg"></div>
</div>

<!-- SELECTION -->
<div id="selection-screen" class="screen hidden">
  <h1>ONLINE BATTLE</h1>
  <div id="sel-hint">[ SELECT YOUR BEAST ]</div>
  <div id="roster" class="roster-grid"></div>
</div>

</div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script src="game-data.js"></script>

<script>
/* ========= FIREBASE ========= */
firebase.initializeApp({
  apiKey: "AIzaSyDxaM9pJz-teyRlh3FGWBqrlmNBoHUI8PI",
  databaseURL: "https://onlinesubsi-default-rtdb.asia-southeast1.firebasedatabase.app"
});
const db = firebase.database();

/* ========= STATE ========= */
let gameMode, roomCode;
let playerRole, myTeam;
let roomRef;
let selectionLocked = false;

/* ========= NAV ========= */
function show(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
}
function goBack(){
  if(roomRef) roomRef.remove();
  location.href="index.html";
}

/* ========= MODE ========= */
function selectGameMode(m){
  gameMode=m;
  show("room-screen");
  document.getElementById("room-title").innerText=m.toUpperCase()+" MODE";
}

/* ========= ROOM ========= */
function hostRoom(){
  roomCode=Math.random().toString(36).substring(2,8).toUpperCase();
  playerRole="p1"; myTeam="A";

  roomRef=db.ref("rooms/"+roomCode);
  roomRef.set({
    mode:gameMode,
    players:{ p1:{team:"A"} },
    phase:"waiting"
  });

  document.getElementById("room-code").innerText=roomCode;
  document.getElementById("room-code-display").classList.remove("hidden");

  listenRoom();
}

function joinRoom(){
  roomCode=document.getElementById("join-code-input").value.toUpperCase();
  roomRef=db.ref("rooms/"+roomCode);

  roomRef.once("value",snap=>{
    if(!snap.exists()) return alert("ROOM NOT FOUND");

    const players=snap.val().players||{};
    const idx=Object.keys(players).length+1;
    playerRole="p"+idx;
    myTeam=idx%2===1?"A":"B";

    roomRef.child("players/"+playerRole).set({team:myTeam});
    listenRoom();
  });
}

/* ========= ROOM LISTENER ========= */
function listenRoom(){
  roomRef.on("value",snap=>{
    const data=snap.val();
    if(!data) return;

    const need =
      data.mode==="1v1"?2:
      data.mode==="1v2"?3:4;

    if(data.phase==="waiting" && Object.keys(data.players).length===need){
      roomRef.child("phase").set("selecting");
      startSelection();
    }

    if(data.phase==="battle"){
      location.href="battle.html?room="+roomCode+"&role="+playerRole;
    }
  });
}

/* ========= SELECTION ========= */
function startSelection(){
  if(selectionLocked) return;
  selectionLocked=true;

  show("selection-screen");
  loadBeasts();
}

function loadBeasts(){
  const r=document.getElementById("roster");
  r.innerHTML="";
  Object.keys(dbData).filter(b=>b!=="Vibhamon").forEach(b=>{
    r.innerHTML+=`
      <div class="card" onclick="pickBeast('${b}')">
        ${b}
      </div>`;
  });
}

function pickBeast(b){
  roomRef.child(`players/${playerRole}/beast`).set(b);
  document.getElementById("sel-hint").innerText="[ SELECT YOUR TRAINER ]";
  loadTrainers();
}

function loadTrainers(){
  const r=document.getElementById("roster");
  r.innerHTML="";
  Object.keys(trainers).filter(t=>t!=="Lord Keshav").forEach(t=>{
    r.innerHTML+=`
      <div class="card" onclick="pickTrainer('${t}')">
        ${t}
      </div>`;
  });
}

function pickTrainer(t){
  roomRef.child(`players/${playerRole}/trainer`).set(t);
  roomRef.child(`players/${playerRole}/ready`).set(true);
  document.getElementById("sel-hint").innerText="[ WAITING FOR OTHERS ]";

  roomRef.once("value",snap=>{
    const p=snap.val().players;
    if(Object.values(p).every(x=>x.ready)){
      roomRef.child("phase").set("battle");
    }
  });
}
</script>

</body>
</html>
